<!DOCTYPE html>
<html lang="en">
<head>
  <meta charset="UTF-8">
  <meta name="viewport" content="width=device-width, initial-scale=1.0">
  <title>OwnYourPrime Meal Tracker</title>
  <!-- Font Awesome for icons -->
  <link rel="stylesheet" href="https://cdnjs.cloudflare.com/ajax/libs/font-awesome/6.4.0/css/all.min.css">
  <!-- Chart.js for analytics -->
  <script src="https://cdn.jsdelivr.net/npm/chart.js"></script>
  <style>
    :root {
      --bg-dark: #0f0f14;
      --card-dark: #1a1a27;
      --card-alt: #2a2a3c;
      --text-light: #f5f5f5;
      --text-muted: #8c8c9c;
      --accent: #00c49a;
      --accent-hover: #00a381;
      --danger: #e66a6a;
      --success: #6fcb9f;
      --radius: 10px;
    }
    * {
      box-sizing: border-box;
    }
    body {
      margin: 0;
      padding: 0;
      font-family: system-ui, -apple-system, BlinkMacSystemFont, 'Segoe UI', Roboto, Oxygen, Ubuntu, Cantarell, 'Open Sans', 'Helvetica Neue', sans-serif;
      background-color: var(--bg-dark);
      color: var(--text-light);
      line-height: 1.4;
    }
    header {
      background-color: var(--card-dark);
      padding: 20px;
      display: flex;
      align-items: center;
      justify-content: space-between;
      border-bottom: 1px solid #222;
    }
    header h1 {
      margin: 0;
      font-size: 1.6rem;
      display: flex;
      align-items: center;
      gap: 8px;
    }
    header .tagline {
      font-size: 0.85rem;
      color: var(--text-muted);
      margin-top: 4px;
    }
    header .actions {
      display: flex;
      align-items: center;
      gap: 10px;
    }
    header .actions button {
      background: none;
      border: none;
      color: var(--text-light);
      cursor: pointer;
      font-size: 1.2rem;
    }
    .container {
      max-width: 1200px;
      margin: 0 auto;
      padding: 20px;
      display: grid;
      grid-template-columns: 1fr 1fr;
      grid-gap: 20px;
    }
    .card {
      background-color: var(--card-dark);
      border-radius: var(--radius);
      padding: 20px;
      box-shadow: 0 2px 5px rgba(0,0,0,0.3);
    }
    .card h2 {
      margin-top: 0;
      margin-bottom: 15px;
      display: flex;
      align-items: center;
      gap: 8px;
    }
    .form-group {
      margin-bottom: 12px;
      display: flex;
      flex-direction: column;
    }
    label {
      margin-bottom: 4px;
      font-weight: 500;
      color: var(--text-muted);
    }
    input[type="text"],
    input[type="number"],
    input[type="date"] {
      padding: 10px 12px;
      border: none;
      border-radius: var(--radius);
      background-color: var(--card-alt);
      color: var(--text-light);
    }
    input[type="number"]::-webkit-inner-spin-button,
    input[type="number"]::-webkit-outer-spin-button {
      -webkit-appearance: none;
      margin: 0;
    }
    button.primary {
      background-color: var(--accent);
      color: var(--bg-dark);
      border: none;
      padding: 10px 18px;
      border-radius: var(--radius);
      font-weight: 600;
      cursor: pointer;
      transition: background-color 0.2s;
    }
    button.primary:hover {
      background-color: var(--accent-hover);
    }
    button.secondary {
      background-color: var(--card-alt);
      color: var(--text-light);
      border: none;
      padding: 8px 14px;
      border-radius: var(--radius);
      cursor: pointer;
    }
    .summary-cards {
      display: flex;
      flex-wrap: wrap;
      gap: 10px;
    }
    .summary-card {
      flex: 1 1 120px;
      background-color: var(--card-alt);
      padding: 10px;
      border-radius: var(--radius);
      display: flex;
      flex-direction: column;
      align-items: center;
      justify-content: center;
    }
    .summary-card .icon {
      font-size: 1.4rem;
      margin-bottom: 4px;
      color: var(--accent);
    }
    .summary-card .value {
      font-size: 1.3rem;
      font-weight: bold;
    }
    .summary-card .label {
      font-size: 0.8rem;
      color: var(--text-muted);
    }
    .progress-bar {
      width: 100%;
      height: 8px;
      background-color: #333;
      border-radius: 4px;
      overflow: hidden;
      margin-top: 4px;
    }
    .progress-bar span {
      display: block;
      height: 100%;
      background-color: var(--accent);
    }
    .meal-table {
      width: 100%;
      border-collapse: collapse;
      margin-top: 10px;
    }
    .meal-table th, .meal-table td {
      padding: 8px;
      border-bottom: 1px solid #3c3c4f;
      text-align: left;
    }
    .meal-table th {
      background-color: var(--card-alt);
    }
    .quick-presets {
      display: flex;
      gap: 10px;
      flex-wrap: wrap;
      margin-bottom: 10px;
    }
    .quick-presets button {
      flex: 1 1 calc(25% - 10px);
      min-width: 100px;
      background-color: var(--card-alt);
      color: var(--text-light);
      border: none;
      padding: 8px;
      border-radius: var(--radius);
      cursor: pointer;
      display: flex;
      flex-direction: column;
      align-items: center;
      justify-content: center;
      gap: 4px;
      transition: background-color 0.2s;
    }
    .quick-presets button:hover {
      background-color: var(--accent-hover);
    }
    .quick-presets .preset-name {
      font-size: 0.85rem;
      font-weight: 600;
    }
    .quick-presets .preset-cal {
      font-size: 0.75rem;
      color: var(--text-muted);
    }
    .settings-panel {
      position: fixed;
      top: 0;
      right: -100%;
      width: 300px;
      height: 100vh;
      background-color: var(--card-dark);
      box-shadow: -2px 0 8px rgba(0,0,0,0.4);
      padding: 20px;
      overflow-y: auto;
      transition: right 0.3s;
      z-index: 100;
    }
    .settings-panel.open {
      right: 0;
    }
    .settings-panel h3 {
      margin-top: 0;
      margin-bottom: 10px;
    }
    .settings-panel .preset-edit {
      margin-bottom: 15px;
      background-color: var(--card-alt);
      padding: 10px;
      border-radius: var(--radius);
    }
    .settings-panel input {
      background-color: var(--card-dark);
    }
    .settings-panel button.save {
      width: 100%;
      margin-top: 10px;
    }
    .chart-container {
      width: 100%;
      margin-top: 20px;
    }
    /* Responsive adjustments */
    @media (max-width: 900px) {
      .container {
        grid-template-columns: 1fr;
      }
    }
  </style>
</head>
<body>
  <header>
    <div>
      <h1><i class="fa-solid fa-bowl-food"></i> OwnYourPrime Meal Tracker</h1>
      <div class="tagline">Log meals, macros, water and see your progress</div>
    </div>
    <div class="actions">
      <button id="openSettings" title="Settings"><i class="fa-solid fa-gear"></i></button>
    </div>
  </header>
  <div class="container">
    <!-- Left column: date, targets, summary, quick water -->
    <div class="card" id="leftColumn">
      <h2><i class="fa-solid fa-calendar-day"></i> Date & Targets</h2>
      <div class="form-group">
        <label for="dateInput">Date</label>
        <input type="date" id="dateInput">
      </div>
      <div class="form-group">
        <label for="targetCalories">Daily Calorie Goal (kcal)</label>
        <input type="number" id="targetCalories" min="0">
      </div>
      <div class="form-group">
        <label for="targetProtein">Daily Protein Goal (g)</label>
        <input type="number" id="targetProtein" min="0">
      </div>
      <div class="form-group">
        <label for="targetCarbs">Daily Carbs Goal (g)</label>
        <input type="number" id="targetCarbs" min="0">
      </div>
      <div class="form-group">
        <label for="targetFat">Daily Fat Goal (g)</label>
        <input type="number" id="targetFat" min="0">
      </div>
      <div class="form-group">
        <label for="targetWater">Daily Water Goal (ml)</label>
        <input type="number" id="targetWater" min="0">
      </div>
      <button class="primary" id="saveTargets">Save Goals</button>
      <h2 style="margin-top: 30px;"><i class="fa-solid fa-chart-bar"></i> Summary</h2>
      <div class="summary-cards" id="summaryCards">
        <!-- summary cards inserted via JS -->
      </div>
      <div style="margin-top: 20px;">
        <h3 style="margin-bottom: 10px;">Water Intake</h3>
        <div class="form-group" style="flex-direction: row; align-items: center; gap: 10px;">
          <input type="number" id="waterInput" placeholder="ml" min="0" style="flex:1;">
          <button class="primary" id="addWaterBtn"><i class="fa-solid fa-plus"></i> Add</button>
        </div>
        <button class="secondary" id="quickWaterBtn" style="margin-top: 5px; width:100%;"><i class="fa-solid fa-droplet"></i> Add 1 glass (250 ml)</button>
        <p style="margin-top: 10px;">Today's water: <strong><span id="waterTotal">0</span> ml</strong></p>
      </div>
    </div>
    <!-- Right column: meal logging, quick presets, meals, analytics, history -->
    <div class="card" id="rightColumn">
      <h2><i class="fa-solid fa-utensils"></i> Add Meal</h2>
      <div class="quick-presets" id="presetButtons">
        <!-- quick preset buttons inserted here -->
      </div>
      <form id="mealForm">
        <div class="form-group">
          <label for="mealName">Meal Name</label>
          <input type="text" id="mealName" placeholder="e.g. Breakfast">
        </div>
        <div class="form-group">
          <label for="ingredients">Ingredients (comma separated)</label>
          <input type="text" id="ingredients" placeholder="e.g. Chicken, Broccoli">
        </div>
        <div class="form-group">
          <label for="calories">Calories (kcal)</label>
          <input type="number" id="calories" min="0">
        </div>
        <div class="form-group">
          <label><input type="checkbox" id="showMacros"> Include Macros</label>
        </div>
        <div id="macroFields" style="display:none;">
          <div class="form-group">
            <label for="protein">Protein (g)</label>
            <input type="number" id="protein" min="0">
          </div>
          <div class="form-group">
            <label for="carbs">Carbs (g)</label>
            <input type="number" id="carbs" min="0">
          </div>
          <div class="form-group">
            <label for="fat">Fat (g)</label>
            <input type="number" id="fat" min="0">
          </div>
        </div>
        <button class="primary" type="submit">Add Meal</button>
      </form>
      <h3 style="margin-top: 25px;">Meals for Today</h3>
      <table class="meal-table">
        <thead>
          <tr>
            <th>Meal</th>
            <th>Ingredients</th>
            <th>Calories</th>
            <th>Protein</th>
            <th>Carbs</th>
            <th>Fat</th>
            <th></th>
          </tr>
        </thead>
        <tbody id="mealBody">
        </tbody>
      </table>
      <h2 style="margin-top: 30px;"><i class="fa-solid fa-chart-pie"></i> Analytics</h2>
      <div class="chart-container">
        <canvas id="weekChart" height="200"></canvas>
        <canvas id="macroChart" height="200" style="margin-top:15px;"></canvas>
      </div>
      <h2 style="margin-top: 30px;"><i class="fa-solid fa-calendar-week"></i> History</h2>
      <div id="historyList" style="max-height: 150px; overflow-y:auto; margin-bottom:20px;"></div>
    </div>
  </div>

  <!-- Settings panel for quick presets -->
  <div id="settingsPanel" class="settings-panel">
    <h3><i class="fa-solid fa-sliders-h"></i> Preset Settings</h3>
    <p style="font-size:0.85rem; color:var(--text-muted);">Edit your quick-add meal presets. You can customise name, ingredients and calories.</p>
    <div id="presetEdits"></div>
    <button class="primary save" id="savePresetBtn">Save Presets</button>
  </div>

<script>
document.addEventListener('DOMContentLoaded', function() {
  // Elements
  const dateInput = document.getElementById('dateInput');
  const saveTargetsBtn = document.getElementById('saveTargets');
  const mealForm = document.getElementById('mealForm');
  const showMacros = document.getElementById('showMacros');
  const macroFields = document.getElementById('macroFields');
  const addWaterBtn = document.getElementById('addWaterBtn');
  const quickWaterBtn = document.getElementById('quickWaterBtn');
  const summaryCards = document.getElementById('summaryCards');
  const mealBody = document.getElementById('mealBody');
  const historyList = document.getElementById('historyList');
  const presetButtonsContainer = document.getElementById('presetButtons');
  const settingsPanel = document.getElementById('settingsPanel');
  const openSettingsBtn = document.getElementById('openSettings');
  const presetEdits = document.getElementById('presetEdits');
  const savePresetBtn = document.getElementById('savePresetBtn');

  // Charts
  let weekChart, macroChart;

  // Default presets (meat/veg common)
  const defaultPresets = [
    { name: 'Chicken Breast', ingredients: 'Chicken breast', calories: 165, protein: 31, carbs: 0, fat: 4 },
    { name: 'Salmon', ingredients: 'Salmon', calories: 206, protein: 22, carbs: 0, fat: 12 },
    { name: 'Broccoli', ingredients: 'Broccoli', calories: 55, protein: 4, carbs: 11, fat: 1 },
    { name: 'Rice', ingredients: 'Rice', calories: 206, protein: 4, carbs: 45, fat: 0 }
  ];

  function getPresets() {
    const raw = localStorage.getItem('presets');
    return raw ? JSON.parse(raw) : defaultPresets;
  }

  function renderPresetButtons() {
    const presets = getPresets();
    presetButtonsContainer.innerHTML = '';
    presets.forEach((preset, idx) => {
      const btn = document.createElement('button');
      btn.innerHTML = `<span class="preset-name">${preset.name}</span><span class="preset-cal">${preset.calories} kcal</span>`;
      btn.addEventListener('click', () => {
        addPresetMeal(preset);
      });
      presetButtonsContainer.appendChild(btn);
    });
  }

  function openSettings() {
    // populate preset edit fields
    const presets = getPresets();
    presetEdits.innerHTML = '';
    presets.forEach((preset, idx) => {
      const div = document.createElement('div');
      div.className = 'preset-edit';
      div.innerHTML = `
        <h4>Preset ${idx + 1}</h4>
        <div class="form-group">
          <label>Name</label>
          <input type="text" id="presetName${idx}" value="${preset.name}">
        </div>
        <div class="form-group">
          <label>Ingredients</label>
          <input type="text" id="presetIng${idx}" value="${preset.ingredients}">
        </div>
        <div class="form-group">
          <label>Calories (kcal)</label>
          <input type="number" id="presetCal${idx}" value="${preset.calories}">
        </div>
        <div class="form-group">
          <label>Protein (g)</label>
          <input type="number" id="presetProt${idx}" value="${preset.protein ?? 0}">
        </div>
        <div class="form-group">
          <label>Carbs (g)</label>
          <input type="number" id="presetCarbs${idx}" value="${preset.carbs ?? 0}">
        </div>
        <div class="form-group">
          <label>Fat (g)</label>
          <input type="number" id="presetFat${idx}" value="${preset.fat ?? 0}">
        </div>
      `;
      presetEdits.appendChild(div);
    });
    settingsPanel.classList.add('open');
  }

  function savePresets() {
    const presets = getPresets();
    // iterate and save new values
    const updated = presets.map((p, idx) => {
      const name = document.getElementById(`presetName${idx}`).value.trim() || `Preset ${idx+1}`;
      const ingredients = document.getElementById(`presetIng${idx}`).value.trim();
      const cal = parseFloat(document.getElementById(`presetCal${idx}`).value) || 0;
      const prot = parseFloat(document.getElementById(`presetProt${idx}`).value) || 0;
      const carbs = parseFloat(document.getElementById(`presetCarbs${idx}`).value) || 0;
      const fat = parseFloat(document.getElementById(`presetFat${idx}`).value) || 0;
      return { name, ingredients, calories: cal, protein: prot, carbs: carbs, fat: fat };
    });
    localStorage.setItem('presets', JSON.stringify(updated));
    renderPresetButtons();
    settingsPanel.classList.remove('open');
  }

  // Add preset meal to current date
  function addPresetMeal(preset) {
    const date = dateInput.value;
    const meals = getMeals(date);
    // Use preset details as a meal entry
    const meal = {
      name: preset.name,
      ingredients: preset.ingredients,
      calories: preset.calories || 0,
      protein: preset.protein || 0,
      carbs: preset.carbs || 0,
      fat: preset.fat || 0
    };
    meals.push(meal);
    saveMeals(date, meals);
    renderMeals(meals);
    updateSummary();
  }

  // Storage helpers
  function getTargets() {
    const raw = localStorage.getItem('targets');
    return raw ? JSON.parse(raw) : {
      calories: 2000,
      protein: 0,
      carbs: 0,
      fat: 0,
      water: 2000
    };
  }
  function saveTargets() {
    const targets = {
      calories: parseFloat(document.getElementById('targetCalories').value) || 0,
      protein: parseFloat(document.getElementById('targetProtein').value) || 0,
      carbs: parseFloat(document.getElementById('targetCarbs').value) || 0,
      fat: parseFloat(document.getElementById('targetFat').value) || 0,
      water: parseFloat(document.getElementById('targetWater').value) || 0
    };
    localStorage.setItem('targets', JSON.stringify(targets));
    updateSummary();
  }
  function getMeals(date) {
    const raw = localStorage.getItem('meals_' + date);
    return raw ? JSON.parse(raw) : [];
  }
  function saveMeals(date, meals) {
    localStorage.setItem('meals_' + date, JSON.stringify(meals));
  }
  function getWater(date) {
    const raw = localStorage.getItem('water_' + date);
    return raw ? parseFloat(raw) : 0;
  }
  function saveWater(date, value) {
    localStorage.setItem('water_' + date, String(value));
  }

  // Meal functions
  function renderMeals(meals) {
    mealBody.innerHTML = '';
    meals.forEach((meal, idx) => {
      const tr = document.createElement('tr');
      tr.innerHTML = `
        <td>${meal.name}</td>
        <td>${meal.ingredients}</td>
        <td>${meal.calories.toFixed(0)}</td>
        <td>${meal.protein ? meal.protein.toFixed(0) : '-'}</td>
        <td>${meal.carbs ? meal.carbs.toFixed(0) : '-'}</td>
        <td>${meal.fat ? meal.fat.toFixed(0) : '-'}</td>
        <td><button class="secondary" onclick="deleteMeal(${idx})" title="Delete"><i class="fa-solid fa-trash"></i></button></td>
      `;
      mealBody.appendChild(tr);
    });
  }
  function addMeal() {
    const date = dateInput.value;
    const name = document.getElementById('mealName').value.trim() || 'Meal';
    const ingredients = document.getElementById('ingredients').value.trim();
    const calories = parseFloat(document.getElementById('calories').value) || 0;
    const meal = {
      name,
      ingredients,
      calories,
      protein: 0,
      carbs: 0,
      fat: 0
    };
    if (showMacros.checked) {
      meal.protein = parseFloat(document.getElementById('protein').value) || 0;
      meal.carbs = parseFloat(document.getElementById('carbs').value) || 0;
      meal.fat = parseFloat(document.getElementById('fat').value) || 0;
    }
    const meals = getMeals(date);
    meals.push(meal);
    saveMeals(date, meals);
    renderMeals(meals);
    updateSummary();
    // reset form
    mealForm.reset();
    macroFields.style.display = 'none';
  }
  window.deleteMeal = function(index) {
    const date = dateInput.value;
    const meals = getMeals(date);
    meals.splice(index, 1);
    saveMeals(date, meals);
    renderMeals(meals);
    updateSummary();
  }

  // Water functions
  function addWater(amount) {
    const date = dateInput.value;
    const current = getWater(date);
    const val = amount !== undefined ? amount : parseFloat(document.getElementById('waterInput').value) || 0;
    const total = current + val;
    saveWater(date, total);
    document.getElementById('waterTotal').textContent = total.toFixed(0);
    updateSummary();
    // clear manual input if from manual entry
    if (amount === undefined) {
      document.getElementById('waterInput').value = '';
    }
  }

  // Summary/Analytics
  function updateSummary() {
    const date = dateInput.value;
    const meals = getMeals(date);
    const targets = getTargets();
    let totalCalories=0, totalProtein=0, totalCarbs=0, totalFat=0;
    meals.forEach(m => {
      totalCalories += m.calories;
      totalProtein += m.protein || 0;
      totalCarbs += m.carbs || 0;
      totalFat += m.fat || 0;
    });
    const water = getWater(date);
    // Build summary cards
    summaryCards.innerHTML = '';
    function createCard(icon, label, value, unit, target) {
      const card = document.createElement('div');
      card.className = 'summary-card';
      card.innerHTML = `
        <div class="icon"><i class="${icon}"></i></div>
        <div class="value">${value.toFixed(0)}${unit ? ' ' + unit : ''}</div>
        <div class="label">${label}</div>
        <div class="progress-bar"><span style="width:${target>0 ? Math.min(100,(value/target)*100) : 0}%"></span></div>
        <div class="label" style="margin-top:2px;">${targetComparison(value, target)}</div>
      `;
      return card;
    }
    summaryCards.appendChild(createCard('fa-solid fa-fire', 'Calories', totalCalories, 'kcal', targets.calories || 0));
    summaryCards.appendChild(createCard('fa-solid fa-drumstick-bite', 'Protein', totalProtein, 'g', targets.protein || 0));
    summaryCards.appendChild(createCard('fa-solid fa-bread-slice', 'Carbs', totalCarbs, 'g', targets.carbs || 0));
    summaryCards.appendChild(createCard('fa-solid fa-bacon', 'Fat', totalFat, 'g', targets.fat || 0));
    summaryCards.appendChild(createCard('fa-solid fa-droplet', 'Water', water, 'ml', targets.water || 0));
    // update water display
    document.getElementById('waterTotal').textContent = water.toFixed(0);
    // update analytics
    updateAnalytics();
    // update history list
    updateHistory();
  }
  function targetComparison(current, target) {
    if (!target || target <= 0) return '';
    if (current === target) return 'On target';
    if (current < target) return `Under by ${(target - current).toFixed(0)}`;
    return `Over by ${(current - target).toFixed(0)}`;
  }

  // History & analytics helpers
  function updateHistory() {
    const dates = [];
    for (let i = 0; i < localStorage.length; i++) {
      const key = localStorage.key(i);
      if (key.startsWith('meals_')) {
        const d = key.substring(6);
        if (!dates.includes(d)) dates.push(d);
      }
    }
    dates.sort().reverse();
    historyList.innerHTML = '';
    dates.forEach(d => {
      const item = document.createElement('div');
      item.className = 'history-item';
      item.style.cursor = 'pointer';
      item.style.padding = '4px 0';
      item.style.borderBottom = '1px solid #2a2a3c';
      item.textContent = d;
      item.addEventListener('click', () => {
        dateInput.value = d;
        loadDay(d);
      });
      historyList.appendChild(item);
    });
  }

  function updateAnalytics() {
    // compute last 7 days
    const days = [];
    const calData = [];
    const proteinData = [];
    const carbsData = [];
    const fatData = [];
    const now = new Date(dateInput.value);
    for (let i = 6; i >= 0; i--) {
      const d = new Date(now);
      d.setDate(d.getDate() - i);
      const dateStr = d.toISOString().split('T')[0];
      days.push(dateStr.slice(5)); // show month-day
      const meals = getMeals(dateStr);
      let c=0,p=0,cab=0,f=0;
      meals.forEach(m => {
        c += m.calories;
        p += m.protein || 0;
        cab += m.carbs || 0;
        f += m.fat || 0;
      });
      calData.push(c);
      proteinData.push(p);
      carbsData.push(cab);
      fatData.push(f);
    }
    // Build weekly calories chart
    const weekCtx = document.getElementById('weekChart').getContext('2d');
    if (weekChart) weekChart.destroy();
    weekChart = new Chart(weekCtx, {
      type: 'bar',
      data: {
        labels: days,
        datasets: [
          { label: 'Calories', data: calData, backgroundColor: 'rgba(0,196,154,0.7)' },
          { label: 'Protein (g)', data: proteinData, backgroundColor: 'rgba(100,149,237,0.7)' },
          { label: 'Carbs (g)', data: carbsData, backgroundColor: 'rgba(255,195,0,0.7)' },
          { label: 'Fat (g)', data: fatData, backgroundColor: 'rgba(239,71,111,0.7)' }
        ]
      },
      options: {
        plugins: {
          legend: { display: true, labels: { color: varToRgb('--text-light') } },
          tooltip: { enabled: true }
        },
        scales: {
          x: { ticks: { color: varToRgb('--text-light') }, grid: { color: '#333' } },
          y: { ticks: { color: varToRgb('--text-light') }, grid: { color: '#333' } }
        }
      }
    });
    // Macro distribution for week total
    let sumProtein=proteinData.reduce((a,b)=>a+b,0);
    let sumCarbs=carbsData.reduce((a,b)=>a+b,0);
    let sumFat=fatData.reduce((a,b)=>a+b,0);
    const macroCtx = document.getElementById('macroChart').getContext('2d');
    if (macroChart) macroChart.destroy();
    macroChart = new Chart(macroCtx, {
      type: 'pie',
      data: {
        labels: ['Protein', 'Carbs', 'Fat'],
        datasets: [{
          data: [sumProtein, sumCarbs, sumFat],
          backgroundColor: [
            'rgba(100,149,237,0.7)',
            'rgba(255,195,0,0.7)',
            'rgba(239,71,111,0.7)'
          ]
        }]
      },
      options: {
        plugins: {
          legend: { labels: { color: varToRgb('--text-light') } }
        }
      }
    });
  }
  // Helper to get CSS var values for Chart.js
  function varToRgb(varName) {
    return getComputedStyle(document.documentElement).getPropertyValue(varName);
  }

  function loadDay(d) {
    // set date input value
    dateInput.value = d;
    const meals = getMeals(d);
    renderMeals(meals);
    const water = getWater(d);
    document.getElementById('waterTotal').textContent = water.toFixed(0);
    updateSummary();
  }

  // Event listeners
  dateInput.addEventListener('change', function() {
    loadDay(this.value);
  });
  saveTargetsBtn.addEventListener('click', function() {
    saveTargets();
  });
  mealForm.addEventListener('submit', function(e) {
    e.preventDefault();
    addMeal();
  });
  showMacros.addEventListener('change', function() {
    macroFields.style.display = this.checked ? 'block' : 'none';
  });
  addWaterBtn.addEventListener('click', function() {
    addWater();
  });
  quickWaterBtn.addEventListener('click', function() {
    addWater(250); // 1 glass = 250ml
  });
  openSettingsBtn.addEventListener('click', function() {
    if (settingsPanel.classList.contains('open')) {
      settingsPanel.classList.remove('open');
    } else {
      openSettings();
    }
  });
  savePresetBtn.addEventListener('click', function() {
    savePresets();
  });

  // Initialization
  (function init() {
    // default date = today
    const today = new Date().toISOString().split('T')[0];
    dateInput.value = today;
    loadDay(today);
    renderPresetButtons();
  })();
});
</script>
</body>
</html>