<!DOCTYPE html>
<html lang="en">
<head>
  <meta charset="UTF-8">
  <meta http-equiv="X-UA-Compatible" content="IE=edge">
  <meta name="viewport" content="width=device-width, initial-scale=1.0">
  <title>GetYourSh@tTogether – All‑in‑One Tracker</title>
  <style>
    /*
      Core styling for the entire application.  This page is designed to be fully
      self contained so that it can be opened anywhere without requiring
      external CSS or JavaScript.  CSS variables are defined on :root to
      provide a coherent colour palette and make it easy to adjust colours.
    */
    :root {
      --color-bg: #eef2f7;
      --color-surface: #ffffff;
      --color-text: #1f2a44;
      --color-muted: #5c6c86;
      --color-primary: #5c6ac4;
      --color-primary-dark: #4b57b0;
      --color-primary-light: rgba(92, 106, 196, 0.12);
      --color-secondary: #2d9cdb;
      --color-secondary-dark: #1f7db3;
      --color-accent: #f76c6c;
      --color-success: #3dbb7c;
      --color-danger: #e74c3c;
      --color-warning: #f0b429;
      --color-info: #9c27b0;
      --kanban-todo: #e3f2fd;
      --kanban-doing: #fff9e6;
      --kanban-done: #e8f5e9;
      --max-habits: 7;
      --shadow-soft: 0 12px 24px rgba(31, 42, 68, 0.08);
      --radius-lg: 18px;
    }

    * {
      box-sizing: border-box;
    }

    body {
      margin: 0;
      font-family: 'Inter', -apple-system, BlinkMacSystemFont, 'Segoe UI', sans-serif;
      background: radial-gradient(circle at top left, rgba(92, 106, 196, 0.15), transparent 55%),
        radial-gradient(circle at bottom right, rgba(45, 156, 219, 0.15), transparent 45%),
        var(--color-bg);
      color: var(--color-text);
      height: 100vh;
      display: flex;
      flex-direction: column;
    }

    header {
      background: linear-gradient(120deg, var(--color-secondary), var(--color-primary));
      color: white;
      padding: 16px 28px;
      display: flex;
      align-items: center;
      justify-content: space-between;
      box-shadow: var(--shadow-soft);
      position: sticky;
      top: 0;
      z-index: 10;
    }

    header h1 {
      margin: 0;
      font-size: 1.7rem;
      letter-spacing: 0.02em;
    }

    header p {
      margin: 4px 0 0;
      font-size: 0.85rem;
      color: rgba(255,255,255,0.85);
    }

    header .brand {
      display: flex;
      flex-direction: column;
      gap: 2px;
    }

    nav {
      display: flex;
      gap: 12px;
      align-items: center;
    }

    nav button {
      background-color: rgba(255, 255, 255, 0.15);
      color: white;
      border: 1px solid rgba(255,255,255,0.25);
      padding: 8px 16px;
      border-radius: 999px;
      cursor: pointer;
      font-size: 0.95rem;
      transition: background 0.2s ease, transform 0.2s ease, box-shadow 0.2s ease;
      backdrop-filter: blur(4px);
    }

    nav button:hover {
      background-color: rgba(255,255,255,0.25);
      transform: translateY(-1px);
      box-shadow: 0 6px 16px rgba(0,0,0,0.15);
    }

    nav button.active {
      background-color: #fff;
      color: var(--color-primary);
      box-shadow: 0 6px 16px rgba(92,106,196,0.25);
    }

    main {
      flex: 1;
      overflow-y: auto;
      position: relative;
    }

    .app-section {
      display: none;
      padding: 28px;
      min-height: calc(100vh - 80px);
      overflow-y: auto;
      animation: fadeIn 0.25s ease;
    }

    .app-section.active {
      display: block;
    }

    @keyframes fadeIn {
      from { opacity: 0; transform: translateY(8px); }
      to { opacity: 1; transform: translateY(0); }
    }

    /* MEAL TRACKER STYLES */
    .section-heading {
      display: flex;
      flex-direction: column;
      gap: 6px;
      margin-bottom: 22px;
    }

    .section-heading h2 {
      margin: 0;
      font-size: 1.85rem;
      color: var(--color-primary-dark);
    }

    .section-heading p {
      margin: 0;
      font-size: 0.95rem;
      color: var(--color-muted);
    }

    .surface-card {
      background: var(--color-surface);
      border-radius: var(--radius-lg);
      box-shadow: var(--shadow-soft);
      padding: 20px;
      position: relative;
      overflow: hidden;
    }

    .surface-card::before {
      content: "";
      position: absolute;
      inset: 0;
      border-radius: inherit;
      pointer-events: none;
      background: linear-gradient(135deg, rgba(92,106,196,0.08), transparent 60%);
    }

    .analytics-grid {
      display: grid;
      grid-template-columns: repeat(auto-fit, minmax(200px, 1fr));
      gap: 18px;
      margin-bottom: 24px;
    }

    .stat-card {
      position: relative;
      border-radius: var(--radius-lg);
      background: linear-gradient(145deg, rgba(92,106,196,0.12), rgba(255,255,255,0.9));
      padding: 18px 20px;
      backdrop-filter: blur(6px);
      box-shadow: var(--shadow-soft);
      display: flex;
      flex-direction: column;
      gap: 6px;
    }

    .stat-card.positive {
      background: linear-gradient(145deg, rgba(61,187,124,0.18), rgba(255,255,255,0.9));
    }

    .stat-card.warning {
      background: linear-gradient(145deg, rgba(240,180,41,0.18), rgba(255,255,255,0.9));
    }

    .stat-card.danger {
      background: linear-gradient(145deg, rgba(231,76,60,0.18), rgba(255,255,255,0.9));
    }

    .stat-card .stat-label {
      font-size: 0.8rem;
      text-transform: uppercase;
      letter-spacing: 0.08em;
      color: var(--color-muted);
    }

    .stat-card .stat-value {
      font-size: 1.8rem;
      font-weight: 600;
      color: var(--color-primary-dark);
    }

    .stat-card.positive .stat-value {
      color: var(--color-success);
    }

    .stat-card.warning .stat-value {
      color: var(--color-warning);
    }

    .stat-card.danger .stat-value {
      color: var(--color-danger);
    }

    .stat-card .stat-detail {
      font-size: 0.85rem;
      color: var(--color-muted);
    }

    .badge {
      display: inline-flex;
      align-items: center;
      gap: 6px;
      background-color: rgba(61, 187, 124, 0.15);
      color: var(--color-success);
      padding: 4px 10px;
      border-radius: 999px;
      font-size: 0.75rem;
      font-weight: 600;
    }

    .badge.danger {
      background-color: rgba(231, 76, 60, 0.12);
      color: var(--color-danger);
    }

    .weight-card {
      display: flex;
      flex-direction: column;
      gap: 12px;
      padding: 22px;
      background: linear-gradient(140deg, rgba(61,187,124,0.18), rgba(92,106,196,0.12));
      border-radius: var(--radius-lg);
      box-shadow: var(--shadow-soft);
      cursor: pointer;
      transition: transform 0.2s ease, box-shadow 0.2s ease;
    }

    .weight-card:hover {
      transform: translateY(-3px);
      box-shadow: 0 16px 34px rgba(61, 77, 120, 0.18);
    }

    .weight-card h3 {
      margin: 0;
      font-size: 1.1rem;
      color: var(--color-text);
    }

    .weight-card .current-weight {
      font-size: 2.1rem;
      font-weight: 600;
      color: var(--color-primary-dark);
    }

    .weight-card .delta {
      font-size: 0.9rem;
      color: var(--color-muted);
    }

    .weight-card .last-updated {
      font-size: 0.8rem;
      color: var(--color-muted);
    }

    .callout {
      font-size: 0.85rem;
      color: var(--color-muted);
      line-height: 1.5;
    }

    .callout strong {
      color: var(--color-text);
    }

    .faded {
      opacity: 0.7;
    }

    .meal-actions {
      display: flex;
      flex-wrap: wrap;
      gap: 12px;
      margin-bottom: 18px;
      align-items: center;
    }

    .meal-actions select,
    .meal-actions button {
      padding: 10px 14px;
      border-radius: 12px;
      border: 1px solid rgba(92,106,196,0.2);
      background-color: #fff;
      color: var(--color-text);
      font-size: 0.9rem;
    }

    .meal-actions select:focus,
    .meal-form input:focus,
    .meal-form textarea:focus,
    .modal-content form input:focus,
    .modal-content form textarea:focus,
    .modal-content form select:focus {
      outline: none;
      border-color: var(--color-primary);
      box-shadow: 0 0 0 3px rgba(92,106,196,0.2);
    }

    #mealSection h2 {
      margin-top: 0;
      color: var(--color-primary-dark);
    }

    .meal-form {
      display: grid;
      grid-template-columns: repeat(auto-fit, minmax(180px, 1fr));
      gap: 18px;
      padding: 22px;
      border-radius: var(--radius-lg);
      background: var(--color-surface);
      box-shadow: var(--shadow-soft);
      margin-bottom: 24px;
      position: relative;
      overflow: hidden;
    }

    .meal-form::before {
      content: "";
      position: absolute;
      inset: 0;
      border-radius: inherit;
      background: linear-gradient(135deg, rgba(45,156,219,0.08), transparent 60%);
      pointer-events: none;
    }

    .meal-form label {
      display: flex;
      flex-direction: column;
      font-weight: bold;
      font-size: 0.85rem;
    }

    .meal-form input,
    .meal-form textarea,
    .meal-form select {
      margin-top: 5px;
      padding: 10px 12px;
      border: 1px solid rgba(92,106,196,0.25);
      border-radius: 12px;
      font-size: 0.95rem;
      width: 100%;
      background: rgba(255,255,255,0.9);
    }

    .meal-form textarea {
      resize: vertical;
      min-height: 60px;
    }

    .meal-form button {
      grid-column: 1 / -1;
      align-self: start;
      background: linear-gradient(135deg, var(--color-primary), var(--color-secondary));
      color: #fff;
      border: none;
      padding: 12px 16px;
      border-radius: 14px;
      cursor: pointer;
      font-size: 1rem;
      font-weight: 600;
      transition: transform 0.2s ease, box-shadow 0.2s ease;
      position: relative;
      z-index: 1;
    }

    .meal-form button:hover {
      transform: translateY(-1px);
      box-shadow: 0 10px 18px rgba(92,106,196,0.25);
    }

    .meal-table {
      width: 100%;
      border-collapse: collapse;
      margin-bottom: 26px;
      border-radius: var(--radius-lg);
      overflow: hidden;
      box-shadow: var(--shadow-soft);
    }

    .meal-table th,
    .meal-table td {
      padding: 14px 16px;
      border-bottom: 1px solid rgba(92,106,196,0.12);
      text-align: left;
      font-size: 0.95rem;
    }

    .meal-table th {
      background: linear-gradient(135deg, var(--color-primary), var(--color-secondary));
      color: white;
      position: sticky;
      top: 0;
      z-index: 1;
    }

    .meal-table tbody tr:nth-child(even) {
      background-color: rgba(92,106,196,0.06);
    }

    .meal-table tbody tr:hover {
      background-color: rgba(92,106,196,0.14);
    }

    .meal-icon {
      font-size: 1.3rem;
      margin-right: 6px;
    }

    .meal-delete {
      color: var(--color-danger);
      cursor: pointer;
      font-weight: bold;
      transition: transform 0.2s ease;
    }

    .meal-delete:hover {
      transform: scale(1.1);
    }

    .summary-list {
      list-style: none;
      padding: 0;
      margin: 0;
      display: flex;
      flex-direction: column;
      gap: 10px;
    }

    .summary-list li {
      margin: 0;
      font-size: 0.95rem;
      padding: 12px 16px;
      border-radius: 12px;
      background: rgba(92,106,196,0.08);
      display: flex;
      justify-content: space-between;
      align-items: center;
      color: var(--color-text);
    }

    .summary-list li span {
      color: var(--color-muted);
      font-size: 0.85rem;
    }

    /* KANBAN BOARD STYLES */
    .settings-grid {
      display: grid;
      grid-template-columns: repeat(auto-fit, minmax(280px, 1fr));
      gap: 24px;
      margin-top: 10px;
    }

    .settings-card {
      background: var(--color-surface);
      border-radius: var(--radius-lg);
      box-shadow: var(--shadow-soft);
      padding: 24px;
      display: flex;
      flex-direction: column;
      gap: 16px;
      position: relative;
      overflow: hidden;
    }

    .settings-card::before {
      content: "";
      position: absolute;
      inset: 0;
      border-radius: inherit;
      background: linear-gradient(135deg, rgba(92,106,196,0.1), transparent 70%);
      pointer-events: none;
    }

    .settings-card h3 {
      margin: 0;
      font-size: 1.1rem;
      color: var(--color-primary-dark);
    }

    .settings-form {
      display: flex;
      flex-direction: column;
      gap: 14px;
      position: relative;
      z-index: 1;
    }

    .settings-form label {
      font-weight: 600;
      font-size: 0.9rem;
      color: var(--color-muted);
      display: flex;
      flex-direction: column;
      gap: 6px;
    }

    .settings-form input,
    .settings-form select,
    .settings-form textarea {
      padding: 10px 12px;
      border-radius: 12px;
      border: 1px solid rgba(92,106,196,0.3);
      font-size: 0.95rem;
      background-color: rgba(255,255,255,0.9);
    }

    .settings-form textarea {
      min-height: 70px;
      resize: vertical;
    }

    .settings-form input:focus,
    .settings-form select:focus,
    .settings-form textarea:focus {
      outline: none;
      border-color: var(--color-primary);
      box-shadow: 0 0 0 3px rgba(92,106,196,0.2);
    }

    .inline-inputs {
      display: grid;
      grid-template-columns: repeat(auto-fit, minmax(120px, 1fr));
      gap: 14px;
    }

    .settings-actions {
      display: flex;
      flex-wrap: wrap;
      gap: 12px;
      margin-top: 6px;
    }

    .settings-actions button {
      border-radius: 12px;
      border: none;
      padding: 10px 16px;
      font-size: 0.95rem;
      font-weight: 600;
      cursor: pointer;
      transition: transform 0.2s ease, box-shadow 0.2s ease;
    }

    .settings-actions button.primary {
      background: linear-gradient(135deg, var(--color-primary), var(--color-secondary));
      color: #fff;
    }

    .settings-actions button.secondary {
      background: rgba(92,106,196,0.12);
      color: var(--color-primary-dark);
    }

    .settings-actions button:hover {
      transform: translateY(-1px);
      box-shadow: 0 12px 20px rgba(92,106,196,0.22);
    }

    .form-helper {
      font-size: 0.8rem;
      color: var(--color-muted);
    }

    .chart-toolbar {
      display: flex;
      justify-content: space-between;
      align-items: center;
      flex-wrap: wrap;
      gap: 12px;
      margin-bottom: 16px;
    }

    .chart-toolbar .range-select {
      display: inline-flex;
      gap: 6px;
      background: rgba(92,106,196,0.12);
      padding: 6px;
      border-radius: 999px;
    }

    .chart-toolbar .range-select button {
      border: none;
      background: transparent;
      padding: 6px 12px;
      border-radius: 999px;
      cursor: pointer;
      font-size: 0.85rem;
      color: var(--color-muted);
      transition: background 0.2s ease, color 0.2s ease;
    }

    .chart-toolbar .range-select button.active {
      background: #fff;
      color: var(--color-primary);
      box-shadow: 0 6px 16px rgba(92,106,196,0.2);
    }

    .chart-legend {
      display: flex;
      gap: 18px;
      font-size: 0.85rem;
      color: var(--color-muted);
    }

    .legend-item {
      display: inline-flex;
      align-items: center;
      gap: 6px;
    }

    .legend-swatch {
      width: 12px;
      height: 12px;
      border-radius: 999px;
    }

    .empty-state {
      text-align: center;
      padding: 32px 16px;
      color: var(--color-muted);
      font-size: 0.95rem;
    }

    .empty-state strong {
      color: var(--color-text);
    }

    .preset-list {
      display: flex;
      flex-direction: column;
      gap: 12px;
      max-height: 300px;
      overflow-y: auto;
      margin-top: 12px;
    }

    .preset-item {
      background: rgba(92,106,196,0.08);
      border-radius: 12px;
      padding: 12px 14px;
      display: flex;
      justify-content: space-between;
      align-items: center;
      gap: 12px;
    }

    .preset-item strong {
      display: block;
      font-size: 1rem;
      color: var(--color-text);
    }

    .preset-item span {
      font-size: 0.85rem;
      color: var(--color-muted);
    }

    .preset-actions {
      display: inline-flex;
      gap: 8px;
    }

    .preset-actions button {
      border: none;
      border-radius: 8px;
      padding: 6px 10px;
      cursor: pointer;
      font-size: 0.8rem;
      font-weight: 600;
    }

    .preset-actions button.edit {
      background: rgba(45,156,219,0.18);
      color: var(--color-secondary-dark);
    }

    .preset-actions button.delete {
      background: rgba(231,76,60,0.16);
      color: var(--color-danger);
    }

    .preset-actions button:disabled {
      opacity: 0.6;
      cursor: not-allowed;
    }

    .modal-content h3 small {
      display: block;
      font-size: 0.75rem;
      font-weight: normal;
      color: var(--color-muted);
    }

    #kanbanSection h2 {
      margin-top: 0;
      color: var(--color-secondary-dark);
    }

    .kanban-controls {
      display: flex;
      flex-wrap: wrap;
      gap: 15px;
      margin-bottom: 20px;
      align-items: center;
    }

    .kanban-controls input[type="text"] {
      flex: 1;
      min-width: 200px;
      padding: 8px;
      border: 1px solid #ccc;
      border-radius: 4px;
      font-size: 0.9rem;
    }

    .kanban-controls button {
      background-color: var(--color-primary);
      color: #fff;
      border: none;
      padding: 8px 14px;
      border-radius: 5px;
      cursor: pointer;
      font-size: 0.9rem;
    }

    .kanban-controls button:hover {
      background-color: var(--color-primary-dark);
    }

    .kanban-board {
      display: flex;
      gap: 15px;
      overflow-x: auto;
    }

    .kanban-column {
      background-color: var(--color-surface);
      border-radius: 8px;
      padding: 10px;
      flex: 1;
      min-width: 300px;
      display: flex;
      flex-direction: column;
      max-height: calc(100vh - 220px);
    }

    .kanban-column.todo {
      background-color: var(--kanban-todo);
    }

    .kanban-column.doing {
      background-color: var(--kanban-doing);
    }

    .kanban-column.done {
      background-color: var(--kanban-done);
    }

    .kanban-column h3 {
      margin: 0 0 10px;
      display: flex;
      align-items: center;
      justify-content: space-between;
      font-size: 1.1rem;
    }

    .kanban-column .limit-input {
      width: 40px;
      padding: 2px;
      border: 1px solid #888;
      border-radius: 4px;
      font-size: 0.8rem;
      text-align: center;
    }

    .kanban-tasks {
      flex: 1;
      overflow-y: auto;
    }

    .kanban-card {
      background-color: var(--color-surface);
      margin: 5px 0;
      padding: 10px;
      border-radius: 6px;
      box-shadow: 0 1px 3px rgba(0,0,0,0.1);
      cursor: grab;
      border-left: 5px solid transparent;
    }

    .kanban-card[data-priority="high"] {
      border-left-color: var(--color-danger);
    }

    .kanban-card[data-priority="medium"] {
      border-left-color: var(--color-warning);
    }

    .kanban-card[data-priority="low"] {
      border-left-color: var(--color-primary);
    }

    .kanban-card h4 {
      margin: 0 0 5px;
      font-size: 0.95rem;
    }

    .kanban-card p {
      margin: 0 0 8px;
      font-size: 0.8rem;
      color: #555;
    }

    .kanban-card .card-footer {
      display: flex;
      align-items: center;
      justify-content: space-between;
      font-size: 0.8rem;
    }

    .kanban-card .assigned {
      display: flex;
      gap: 4px;
    }

    .kanban-card .avatar {
      width: 22px;
      height: 22px;
      border-radius: 50%;
      display: flex;
      align-items: center;
      justify-content: center;
      color: #fff;
      font-size: 0.7rem;
      font-weight: bold;
    }

    .kanban-card .delete-btn {
      color: var(--color-danger);
      cursor: pointer;
      font-size: 1rem;
    }

    /* Modal styles (used for task and habit forms) */
    .modal {
      position: fixed;
      top: 0;
      left: 0;
      width: 100%;
      height: 100%;
      background: rgba(0, 0, 0, 0.5);
      display: none;
      align-items: center;
      justify-content: center;
      z-index: 1000;
    }

    .modal-content {
      background-color: var(--color-surface);
      padding: 20px;
      border-radius: 8px;
      width: 90%;
      max-width: 500px;
      box-shadow: 0 2px 6px rgba(0,0,0,0.2);
    }

    .modal-content h3 {
      margin-top: 0;
      margin-bottom: 10px;
      color: var(--color-secondary-dark);
    }

    .modal-content form {
      display: flex;
      flex-direction: column;
      gap: 10px;
    }

    .modal-content form input,
    .modal-content form textarea,
    .modal-content form select {
      padding: 8px;
      border: 1px solid #ccc;
      border-radius: 4px;
      font-size: 0.9rem;
    }

    .modal-content form label {
      font-size: 0.85rem;
      font-weight: bold;
      margin-bottom: 3px;
    }

    .modal-content .modal-actions {
      display: flex;
      justify-content: flex-end;
      gap: 10px;
      margin-top: 15px;
    }

    .modal-content button {
      padding: 8px 14px;
      border: none;
      border-radius: 4px;
      font-size: 0.9rem;
      cursor: pointer;
    }

    .modal-content button.primary {
      background-color: var(--color-primary);
      color: #fff;
    }

    .modal-content button.secondary {
      background-color: #bbb;
      color: #333;
    }

    .modal-content button.delete {
      background-color: var(--color-danger);
      color: #fff;
    }

    /* HABIT TRACKER STYLES */
    #habitSection h2 {
      margin-top: 0;
      color: var(--color-info);
    }

    .habit-controls {
      display: flex;
      flex-wrap: wrap;
      gap: 10px;
      margin-bottom: 20px;
    }

    .habit-controls button {
      background-color: var(--color-secondary);
      color: #fff;
      border: none;
      padding: 8px 14px;
      border-radius: 5px;
      cursor: pointer;
      font-size: 0.9rem;
    }

    .habit-controls button:hover {
      background-color: var(--color-secondary-dark);
    }

    .habit-table {
      width: 100%;
      overflow-x: auto;
    }

    .habit-row {
      display: grid;
      /* four columns: name, chart, cells, actions */
      grid-template-columns: 200px 100px 1fr auto;
      align-items: center;
      margin-bottom: 10px;
      padding: 10px;
      background-color: var(--color-surface);
      border-radius: 6px;
      box-shadow: 0 1px 3px rgba(0,0,0,0.1);
    }

    .habit-name {
      font-weight: bold;
      font-size: 0.95rem;
      display: flex;
      align-items: center;
      gap: 6px;
    }

    .habit-name .color-indicator {
      width: 14px;
      height: 14px;
      border-radius: 3px;
    }

    .habit-actions {
      display: flex;
      gap: 6px;
      justify-content: flex-end;
    }

    .habit-actions span {
      cursor: pointer;
      font-size: 0.9rem;
      padding: 2px 6px;
      border-radius: 4px;
    }

    .habit-actions .edit-btn {
      background-color: var(--color-primary);
      color: #fff;
    }

    .habit-actions .delete-btn {
      background-color: var(--color-danger);
      color: #fff;
    }

    .habit-streak {
      font-size: 0.8rem;
      color: var(--color-primary-dark);
    }

    .habit-chart {
      width: 100px;
      height: 40px;
    }

    .habit-cells {
      display: grid;
      grid-template-columns: repeat(14, 24px);
      gap: 4px;
      overflow-x: auto;
    }

    .habit-cell {
      width: 24px;
      height: 24px;
      border-radius: 3px;
      border: 1px solid #ddd;
      cursor: pointer;
      display: flex;
      align-items: center;
      justify-content: center;
      font-size: 0.8rem;
      user-select: none;
    }

    .habit-cell.done {
      background-color: var(--color-primary);
      color: #fff;
    }

    .habit-cell.skip {
      background-color: var(--color-warning);
      color: #fff;
    }

    .habit-cell.none {
      background-color: #ecf0f1;
      color: #7f8c8d;
    }

    /* Responsive layout adjustments */
    @media (max-width: 700px) {
      nav button {
        font-size: 0.8rem;
        padding: 6px 10px;
      }
      .kanban-column {
        min-width: 250px;
      }
      .habit-row {
        grid-template-columns: 150px 80px 1fr;
        font-size: 0.8rem;
      }
      .habit-controls button {
        font-size: 0.8rem;
        padding: 6px 10px;
      }
    }
  </style>
</head>
<body>
  <header>
    <div class="brand">
      <h1>GetYourSh@tTogether</h1>
      <p>Your personal performance & wellness cockpit</p>
    </div>
    <nav>
      <button id="navMeal" class="active">Meal Tracker</button>
      <button id="navKanban">Kanban Board</button>
      <button id="navHabit">Habit Tracker</button>
      <button id="navSettings">Settings</button>
    </nav>
  </header>
  <main>
    <!-- Meal Tracker Section -->
    <section id="mealSection" class="app-section active">
      <div class="section-heading">
        <h2>Healthy Meal Tracker</h2>
        <p>Log mindful meals, visualise calories, and keep your nutrition in sync with your goals.</p>
      </div>
      <div class="meal-actions">
        <select id="presetMealSelect">
          <option value="">Use a preset meal…</option>
        </select>
        <span class="callout">
          Tip: curate your go-to meals in <strong>Settings → Preset Meals</strong> for one tap logging.
        </span>
      </div>
      <form class="meal-form" id="mealForm">
        <label>Date
          <input type="date" id="mealDate" required />
        </label>
        <label>Meal Name
          <input type="text" id="mealName" placeholder="Breakfast, Lunch..." required />
        </label>
        <label>Meal Time <span class="form-helper">Optional</span>
          <input type="time" id="mealTime" />
        </label>
        <label>Ingredients (comma separated)
          <textarea id="mealIngredients" placeholder="e.g. eggs, bread, bacon"></textarea>
        </label>
        <label>Calories
          <input type="number" id="mealCalories" min="0" placeholder="e.g. 500" required />
        </label>
        <button type="submit">Add Meal</button>
      </form>
      <div class="analytics-grid" id="analyticsPanel">
        <div class="stat-card" id="todayCaloriesCard">
          <span class="stat-label">Today</span>
          <span class="stat-value" data-field="value">0 kcal</span>
          <span class="stat-detail" data-field="detail">No meals logged yet.</span>
        </div>
        <div class="stat-card" id="weeklyCaloriesCard">
          <span class="stat-label">7 day avg</span>
          <span class="stat-value" data-field="value">0 kcal</span>
          <span class="stat-detail" data-field="detail">Keep logging to see trends.</span>
        </div>
        <div class="stat-card" id="targetCaloriesCard">
          <span class="stat-label">Goal pace</span>
          <span class="stat-value" data-field="value">—</span>
          <span class="stat-detail" data-field="detail">Set your weight & target in settings.</span>
        </div>
      </div>
      <div class="weight-card" id="weightCard">
        <h3>Weight trajectory</h3>
        <div class="current-weight" data-field="weight">— kg</div>
        <div class="delta" data-field="delta">No weight updates yet</div>
        <div class="last-updated" data-field="updated">Tap to log and view your journey</div>
      </div>
      <table class="meal-table" id="mealTable">
        <thead>
          <tr>
            <th>Date</th>
            <th>Time</th>
            <th>Meal</th>
            <th>Ingredients</th>
            <th>Calories</th>
            <th>Action</th>
          </tr>
        </thead>
        <tbody>
        </tbody>
      </table>
      <div class="surface-card">
        <h3 style="margin-top:0; color: var(--color-primary-dark);">Daily Summary</h3>
        <ul class="summary-list" id="summaryList"></ul>
      </div>
    </section>
    <!-- Kanban Board Section -->
    <section id="kanbanSection" class="app-section">
      <h2>Kanban Board</h2>
      <div class="kanban-controls">
        <input type="text" id="taskSearch" placeholder="Search tasks..." />
        <button id="addTaskBtn">Add Task</button>
      </div>
      <div class="kanban-board" id="kanbanBoard">
        <div class="kanban-column todo" data-status="todo">
          <h3>To&nbsp;Do <input type="number" class="limit-input" id="limit-todo" min="0" value="" placeholder="∞" /></h3>
          <div class="kanban-tasks" id="tasks-todo"></div>
        </div>
        <div class="kanban-column doing" data-status="doing">
          <h3>Doing <input type="number" class="limit-input" id="limit-doing" min="0" value="3" /></h3>
          <div class="kanban-tasks" id="tasks-doing"></div>
        </div>
        <div class="kanban-column done" data-status="done">
          <h3>Done <input type="number" class="limit-input" id="limit-done" min="0" value="" placeholder="∞" /></h3>
          <div class="kanban-tasks" id="tasks-done"></div>
        </div>
      </div>
    </section>
    <!-- Habit Tracker Section -->
    <section id="habitSection" class="app-section">
      <h2>Micro Habit Tracker</h2>
      <div class="habit-controls">
        <button id="addHabitBtn">Add Habit</button>
        <button id="exportHabitsBtn">Export Habits</button>
        <label style="display: inline-flex; align-items: center; gap: 5px; cursor: pointer;">
          <span style="background-color: var(--color-secondary-dark); color: #fff; padding: 8px 14px; border-radius: 5px; font-size: 0.9rem;">Import Habits</span>
          <input type="file" id="importHabitsInput" accept=".json" style="display:none;" />
        </label>
      </div>
      <div class="habit-table" id="habitTable">
      </div>
    </section>
    <!-- Settings Section -->
    <section id="settingsSection" class="app-section">
      <div class="section-heading">
        <h2>Settings &amp; Personalisation</h2>
        <p>Keep your profile, targets, and quick actions up to date so insights stay meaningful.</p>
      </div>
      <div class="settings-grid">
        <div class="settings-card">
          <h3>Profile details</h3>
          <form id="profileForm" class="settings-form">
            <div class="inline-inputs">
              <label>Age
                <input type="number" id="profileAge" min="0" placeholder="29" />
              </label>
              <label>Height (cm)
                <input type="number" id="profileHeight" min="0" step="0.5" placeholder="175" />
              </label>
              <label>Current weight (kg)
                <input type="number" id="profileWeight" min="0" step="0.1" placeholder="72.4" />
              </label>
            </div>
            <label>Lifestyle
              <select id="profileLifestyle">
                <option value="sedentary">Sedentary</option>
                <option value="light">Lightly active</option>
                <option value="moderate">Moderately active</option>
                <option value="active">Active</option>
                <option value="athlete">Athlete</option>
              </select>
            </label>
            <div class="callout"><strong>BMI</strong>: <span id="bmiValue">—</span> <span id="bmiCategory" class="faded"></span></div>
            <div class="settings-actions">
              <button type="submit" class="primary">Save profile</button>
              <button type="button" class="secondary" id="quickWeightLogBtn">Log new weight</button>
            </div>
          </form>
        </div>
        <div class="settings-card">
          <h3>Targets</h3>
          <form id="targetForm" class="settings-form">
            <label>Target weight (kg)
              <input type="number" id="targetWeight" min="0" step="0.1" placeholder="68" />
            </label>
            <label>Objective
              <select id="goalType">
                <option value="maintain">Maintain</option>
                <option value="loss">Weight loss</option>
                <option value="gain">Weight gain</option>
              </select>
            </label>
            <label>Weekly change (kg/week)
              <input type="number" id="weeklyChange" min="-5" max="5" step="0.1" placeholder="0.5" />
              <span class="form-helper">We cap adjustments at ±5 kg/week to stay realistic.</span>
            </label>
            <div class="callout" id="targetProjection">Set your targets to unlock smart projections.</div>
            <div class="settings-actions">
              <button type="submit" class="primary">Save target</button>
            </div>
          </form>
        </div>
        <div class="settings-card">
          <h3>Preset meals</h3>
          <p class="callout">Curate up to ten meals you eat often. They appear in the meal tracker for lightning-fast logging.</p>
          <div class="settings-actions">
            <button type="button" class="primary" id="managePresetMealsBtn">Manage preset meals</button>
          </div>
        </div>
      </div>
    </section>
  </main>

  <!-- Modal for adding/editing tasks -->
  <div class="modal" id="taskModal">
    <div class="modal-content">
      <h3 id="taskModalTitle">Add Task</h3>
      <form id="taskForm">
        <label for="taskTitle">Title</label>
        <input type="text" id="taskTitle" required />
        <label for="taskDesc">Description</label>
        <textarea id="taskDesc" rows="3"></textarea>
        <label for="taskPriority">Priority</label>
        <select id="taskPriority">
          <option value="high">High</option>
          <option value="medium">Medium</option>
          <option value="low" selected>Low</option>
        </select>
        <label for="taskAssigned">Assign to (comma separated names)</label>
        <input type="text" id="taskAssigned" placeholder="e.g. Alice, Bob" />
        <div class="modal-actions">
          <button type="button" class="secondary" id="cancelTaskBtn">Cancel</button>
          <button type="submit" class="primary">Save</button>
        </div>
      </form>
    </div>
  </div>

  <!-- Modal for adding/editing habits -->
  <div class="modal" id="habitModal">
    <div class="modal-content">
      <h3 id="habitModalTitle">Add Habit</h3>
      <form id="habitForm">
        <label for="habitName">Habit Name</label>
        <input type="text" id="habitName" required />
        <div class="modal-actions">
          <button type="button" class="secondary" id="cancelHabitBtn">Cancel</button>
          <button type="submit" class="primary">Save</button>
        </div>
      </form>
    </div>
  </div>

  <!-- Modal for managing preset meals -->
  <div class="modal" id="presetMealsModal">
    <div class="modal-content" style="max-width: 600px;">
      <h3>Preset meals <small>Capture your staples (max 10)</small></h3>
      <form id="presetMealForm" class="settings-form">
        <label>Meal name
          <input type="text" id="presetMealName" placeholder="Protein oats" required />
        </label>
        <label>Default ingredients <span class="form-helper">Comma separated, optional</span>
          <textarea id="presetMealIngredients" rows="2" placeholder="oats, whey, banana"></textarea>
        </label>
        <div class="inline-inputs">
          <label>Calories
            <input type="number" id="presetMealCalories" min="0" step="1" placeholder="420" required />
          </label>
          <label>Default time <span class="form-helper">Optional</span>
            <input type="time" id="presetMealTime" />
          </label>
        </div>
        <div class="modal-actions">
          <button type="button" class="secondary" id="cancelPresetMealBtn">Close</button>
          <button type="submit" class="primary">Save meal</button>
        </div>
      </form>
      <div class="preset-list" id="presetMealsList"></div>
    </div>
  </div>

  <!-- Modal for weight tracker -->
  <div class="modal" id="weightModal">
    <div class="modal-content" style="max-width: 720px;">
      <h3>Weight progress <small>Track your trend, aim for sustainable progress</small></h3>
      <div class="chart-toolbar">
        <div class="range-select" id="weightRangeSelect">
          <button type="button" data-range="daily" class="active">Daily</button>
          <button type="button" data-range="weekly">Weekly</button>
          <button type="button" data-range="monthly">Monthly</button>
        </div>
        <div class="chart-legend">
          <span class="legend-item"><span class="legend-swatch" style="background: var(--color-primary);"></span>Logged weight</span>
          <span class="legend-item"><span class="legend-swatch" style="background: var(--color-accent);"></span>Target</span>
        </div>
      </div>
      <canvas id="weightChart" width="640" height="260" style="width:100%; height:auto;"></canvas>
      <div class="empty-state" id="weightEmptyState" hidden>
        <strong>No entries yet.</strong> Log your current weight or save a target to see the projected trend line.
      </div>
      <form id="weightForm" class="settings-form" style="margin-top: 18px;">
        <div class="inline-inputs">
          <label>Log date
            <input type="date" id="weightDate" required />
          </label>
          <label>Weight (kg)
            <input type="number" id="weightValue" min="0" step="0.1" required />
          </label>
        </div>
        <div class="settings-actions">
          <button type="button" class="secondary" id="closeWeightModalBtn">Close</button>
          <button type="submit" class="primary">Save weight</button>
        </div>
      </form>
      <div class="callout" id="weightTrajectoryText"></div>
    </div>
  </div>

  <script>
    /*
      The JavaScript below implements the core logic for the multi‑purpose app.
      It stores state in localStorage so that data persists across sessions.  If no
      data exists when the page loads, default datasets will be created for
      demonstration purposes.  Each section (meal tracker, kanban, habits) is
      encapsulated with its own functions to keep logic organised.  The app
      provides dynamic interactions such as drag‑and‑drop for the Kanban board,
      habit streak calculations, JSON import/export, and responsive UI updates.
    */

    // ===== UTILITY FUNCTIONS =====
    const STORAGE_KEYS = {
      meals: 'lifeos:gyst:meals',
      presetMeals: 'lifeos:gyst:presetMeals',
      profile: 'lifeos:gyst:profile',
      targets: 'lifeos:gyst:targets',
      weightHistory: 'lifeos:gyst:weightHistory',
      tasks: 'lifeos:gyst:kanban:tasks',
      wipLimits: 'lifeos:gyst:kanban:wipLimits',
      habits: 'lifeos:gyst:habits'
    };

    function resolveStorageKey(key) {
      return STORAGE_KEYS[key] || key;
    }

    function safeParseJSON(raw, fallback, keyForQuarantine = '') {
      if (typeof raw !== 'string') return fallback;
      try {
        return JSON.parse(raw);
      } catch (error) {
        console.warn(`Invalid JSON in storage key "${keyForQuarantine}"`, error);
        if (keyForQuarantine) {
          const ts = Date.now();
          localStorage.setItem(`${keyForQuarantine}__corrupt__${ts}`, raw);
          localStorage.removeItem(keyForQuarantine);
        }
        return fallback;
      }
    }

    function safeGetStorage(key, fallback = null) {
      const namespacedKey = resolveStorageKey(key);
      const raw = localStorage.getItem(namespacedKey);
      return raw ? safeParseJSON(raw, fallback, namespacedKey) : fallback;
    }

    function safeSetStorage(key, data) {
      localStorage.setItem(resolveStorageKey(key), JSON.stringify(data));
    }

    function migrateStorageKeys() {
      Object.entries(STORAGE_KEYS).forEach(([legacy, namespaced]) => {
        if (localStorage.getItem(namespaced) !== null) return;
        const legacyRaw = localStorage.getItem(legacy);
        if (legacyRaw === null) return;
        const parsed = safeParseJSON(legacyRaw, null, legacy);
        if (parsed !== null) {
          localStorage.setItem(namespaced, JSON.stringify(parsed));
        }
        localStorage.removeItem(legacy);
      });
    }

    function saveToStorage(key, data) {
      safeSetStorage(key, data);
    }
    function loadFromStorage(key, fallback = null) {
      return safeGetStorage(key, fallback);
    }
    function generateId() {
      return Date.now().toString(36) + Math.random().toString(36).substr(2, 5);
    }
    function escapeHtml(str) {
      const div = document.createElement('div');
      div.textContent = str;
      return div.innerHTML;
    }
    // Generate a consistent pastel colour for a given string (used for avatars)
    function hashStringToColor(str) {
      let hash = 0;
      for (let i = 0; i < str.length; i++) {
        hash = str.charCodeAt(i) + ((hash << 5) - hash);
      }
      const hue = hash % 360;
      return `hsl(${hue}, 70%, 50%)`;
    }
    // Format date as YYYY‑MM‑DD
    function formatDate(date) {
      const y = date.getFullYear();
      const m = String(date.getMonth() + 1).padStart(2, '0');
      const d = String(date.getDate()).padStart(2, '0');
      return `${y}-${m}-${d}`;
    }

    function normalizeMeal(meal) {
      if (!meal || typeof meal !== 'object') return null;
      const calories = Number(meal.calories);
      const date = typeof meal.date === 'string' ? meal.date : '';
      const name = typeof meal.name === 'string' ? meal.name.trim() : '';
      if (!date || !name || Number.isNaN(calories)) return null;
      return {
        id: meal.id || generateId(),
        date,
        time: typeof meal.time === 'string' ? meal.time : '',
        name,
        ingredients: Array.isArray(meal.ingredients) ? meal.ingredients.map(i => String(i).trim()).filter(Boolean) : [],
        calories: Math.max(0, Math.round(calories))
      };
    }

    function normalizeTask(task) {
      if (!task || typeof task !== 'object') return null;
      const status = ['todo', 'doing', 'done'].includes(task.status) ? task.status : 'todo';
      const title = typeof task.title === 'string' ? task.title.trim() : '';
      if (!title) return null;
      const assignedRaw = Array.isArray(task.assigned) ? task.assigned : [];
      return {
        id: task.id || generateId(),
        title,
        description: typeof task.description === 'string' ? task.description : '',
        priority: ['low', 'medium', 'high', 'urgent'].includes(task.priority) ? task.priority : 'low',
        assigned: assignedRaw.map(a => String(a).trim()).filter(Boolean),
        status
      };
    }

    function normalizeHabit(habit) {
      if (!habit || typeof habit !== 'object') return null;
      const name = typeof habit.name === 'string' ? habit.name.trim() : '';
      if (!name) return null;
      const history = {};
      const rawHistory = habit.history && typeof habit.history === 'object' ? habit.history : {};
      Object.entries(rawHistory).forEach(([date, state]) => {
        if (typeof date !== 'string') return;
        if (state === 'done' || state === 'skip' || state === 'none') {
          history[date] = state;
        }
      });
      return {
        id: habit.id || generateId(),
        name,
        color: typeof habit.color === 'string' ? habit.color : '#6B5B95',
        history
      };
    }

    function normalizeWipLimits(value) {
      const fallback = { todo: null, doing: 3, done: null };
      if (!value || typeof value !== 'object') return fallback;
      const out = { ...fallback };
      ['todo', 'doing', 'done'].forEach((status) => {
        const n = Number(value[status]);
        out[status] = Number.isFinite(n) && n >= 0 ? n : null;
      });
      return out;
    }

    migrateStorageKeys();

    // ===== NAVIGATION HANDLING =====
    const navMealBtn = document.getElementById('navMeal');
    const navKanbanBtn = document.getElementById('navKanban');
    const navHabitBtn = document.getElementById('navHabit');
    const navSettingsBtn = document.getElementById('navSettings');
    const sections = {
      meal: document.getElementById('mealSection'),
      kanban: document.getElementById('kanbanSection'),
      habit: document.getElementById('habitSection'),
      settings: document.getElementById('settingsSection'),
    };
    const navButtons = {
      meal: navMealBtn,
      kanban: navKanbanBtn,
      habit: navHabitBtn,
      settings: navSettingsBtn,
    };

    function showSection(name) {
      for (const key in sections) {
        sections[key].classList.toggle('active', key === name);
      }
      for (const key in navButtons) {
        navButtons[key].classList.toggle('active', key === name);
      }
    }

    navMealBtn.addEventListener('click', () => showSection('meal'));
    navKanbanBtn.addEventListener('click', () => showSection('kanban'));
    navHabitBtn.addEventListener('click', () => showSection('habit'));
    navSettingsBtn.addEventListener('click', () => showSection('settings'));

    // ===== MEAL TRACKER =====
    let meals = (loadFromStorage('meals', []) || []).map(normalizeMeal).filter(Boolean);
    // If there are no meals, set default example data for demonstration
    if (meals.length === 0) {
      const today = new Date();
      const yesterday = new Date(Date.now() - 86400000);
      meals = [
        { id: generateId(), date: formatDate(today), time: '07:45', name: 'Breakfast', ingredients: ['eggs', 'toast', 'avocado'], calories: 450 },
        { id: generateId(), date: formatDate(today), time: '12:45', name: 'Lunch', ingredients: ['salad', 'chicken breast'], calories: 600 },
        { id: generateId(), date: formatDate(yesterday), time: '19:15', name: 'Dinner', ingredients: ['pasta', 'tomato sauce'], calories: 700 },
      ];
      saveToStorage('meals', meals);
    }

    let presetMeals = loadFromStorage('presetMeals', []);
    if (!Array.isArray(presetMeals) || presetMeals.length === 0) {
      presetMeals = [
        { id: generateId(), name: 'Protein oats', calories: 420, time: '07:30', ingredients: 'oats, whey, banana' },
        { id: generateId(), name: 'Lean lunch bowl', calories: 540, time: '12:30', ingredients: 'quinoa, chicken, greens' },
        { id: generateId(), name: 'Recovery shake', calories: 320, time: '16:00', ingredients: 'berries, yogurt, almond butter' },
      ];
      saveToStorage('presetMeals', presetMeals);
    } else {
      presetMeals = presetMeals.map(meal => ({
        id: meal.id || generateId(),
        name: meal.name,
        calories: meal.calories,
        time: meal.time || '',
        ingredients: meal.ingredients || '',
      }));
      saveToStorage('presetMeals', presetMeals);
    }

    let profile = loadFromStorage('profile', {
      age: 29,
      height: 175,
      weight: 72.5,
      lifestyle: 'moderate',
    });

    let targets = loadFromStorage('targets', {
      targetWeight: 68,
      goalType: 'loss',
      weeklyChange: -0.5,
    });
    targets = {
      targetWeight: targets.targetWeight === '' || targets.targetWeight === null || targets.targetWeight === undefined
        ? ''
        : Number(targets.targetWeight),
      goalType: targets.goalType || 'maintain',
      weeklyChange: Number(targets.weeklyChange || 0),
    };

    let weightHistory = loadFromStorage('weightHistory', []);
    if (!Array.isArray(weightHistory)) weightHistory = [];
    weightHistory = weightHistory.map(entry => ({
      date: entry.date,
      weight: Number(entry.weight),
    })).filter(entry => entry.date && !Number.isNaN(entry.weight));
    weightHistory.sort((a, b) => a.date.localeCompare(b.date));
    if (weightHistory.length === 0 && profile.weight) {
      const sample = [];
      for (let i = 5; i >= 0; i--) {
        const d = new Date();
        d.setDate(d.getDate() - i * 7);
        sample.push({
          date: formatDate(d),
          weight: Number((Number(profile.weight) + i * 0.4).toFixed(1)),
        });
      }
      weightHistory = sample;
      saveToStorage('weightHistory', weightHistory);
    }

    const mealForm = document.getElementById('mealForm');
    const mealTableBody = document.querySelector('#mealTable tbody');
    const summaryList = document.getElementById('summaryList');
    const mealDateInput = document.getElementById('mealDate');
    const mealNameInput = document.getElementById('mealName');
    const mealTimeInput = document.getElementById('mealTime');
    const mealIngredientsInput = document.getElementById('mealIngredients');
    const mealCaloriesInput = document.getElementById('mealCalories');
    const presetMealSelect = document.getElementById('presetMealSelect');
    const analyticsCards = {
      today: document.getElementById('todayCaloriesCard'),
      weekly: document.getElementById('weeklyCaloriesCard'),
      target: document.getElementById('targetCaloriesCard'),
    };
    const weightCard = document.getElementById('weightCard');
    const weightCardFields = {
      weight: weightCard.querySelector('[data-field="weight"]'),
      delta: weightCard.querySelector('[data-field="delta"]'),
      updated: weightCard.querySelector('[data-field="updated"]'),
    };
    const profileForm = document.getElementById('profileForm');
    const profileAgeInput = document.getElementById('profileAge');
    const profileHeightInput = document.getElementById('profileHeight');
    const profileWeightInput = document.getElementById('profileWeight');
    const profileLifestyleSelect = document.getElementById('profileLifestyle');
    const bmiValue = document.getElementById('bmiValue');
    const bmiCategory = document.getElementById('bmiCategory');
    const quickWeightLogBtn = document.getElementById('quickWeightLogBtn');
    const targetForm = document.getElementById('targetForm');
    const targetWeightInput = document.getElementById('targetWeight');
    const goalTypeSelect = document.getElementById('goalType');
    const weeklyChangeInput = document.getElementById('weeklyChange');
    const targetProjection = document.getElementById('targetProjection');
    const managePresetMealsBtn = document.getElementById('managePresetMealsBtn');
    const presetMealsModal = document.getElementById('presetMealsModal');
    const presetMealForm = document.getElementById('presetMealForm');
    const presetMealNameInput = document.getElementById('presetMealName');
    const presetMealIngredientsInput = document.getElementById('presetMealIngredients');
    const presetMealCaloriesInput = document.getElementById('presetMealCalories');
    const presetMealTimeInput = document.getElementById('presetMealTime');
    const presetMealsList = document.getElementById('presetMealsList');
    const presetMealSubmitBtn = presetMealForm.querySelector('button.primary');
    const cancelPresetMealBtn = document.getElementById('cancelPresetMealBtn');
    const weightModal = document.getElementById('weightModal');
    const weightForm = document.getElementById('weightForm');
    const weightDateInput = document.getElementById('weightDate');
    const weightValueInput = document.getElementById('weightValue');
    const closeWeightModalBtn = document.getElementById('closeWeightModalBtn');
    const weightChart = document.getElementById('weightChart');
    const weightRangeSelect = document.getElementById('weightRangeSelect');
    const weightEmptyState = document.getElementById('weightEmptyState');
    const weightTrajectoryText = document.getElementById('weightTrajectoryText');
    let editingPresetId = null;
    let currentWeightRange = 'daily';

    function getMealIcon(name) {
      const lc = name.toLowerCase();
      if (lc.includes('breakfast')) return '🍳';
      if (lc.includes('lunch')) return '🥪';
      if (lc.includes('dinner')) return '🍝';
      if (lc.includes('snack')) return '🍎';
      if (lc.includes('salad')) return '🥗';
      return '🍽️';
    }

    function renderMeals() {
      mealTableBody.innerHTML = '';
      meals.forEach(meal => {
        const tr = document.createElement('tr');
        const ingredients = Array.isArray(meal.ingredients)
          ? meal.ingredients
          : (meal.ingredients ? meal.ingredients.split(',') : []);
        const timeDisplay = meal.time ? meal.time : '—';
        tr.innerHTML = `
          <td>${escapeHtml(meal.date)}</td>
          <td>${escapeHtml(timeDisplay)}</td>
          <td><span class="meal-icon">${getMealIcon(meal.name)}</span>${escapeHtml(meal.name)}</td>
          <td>${ingredients.map(i => escapeHtml(i.trim())).join(', ')}</td>
          <td>${meal.calories}</td>
          <td><span class="meal-delete" data-id="${meal.id}">✕</span></td>
        `;
        mealTableBody.appendChild(tr);
      });
      renderSummary();
      renderAnalytics();
    }

    function formatHumanDate(dateStr) {
      const date = new Date(`${dateStr}T00:00:00`);
      if (Number.isNaN(date.getTime())) return dateStr;
      return date.toLocaleDateString(undefined, { month: 'short', day: 'numeric' });
    }

    function getMealAnalytics() {
      const todayStr = formatDate(new Date());
      const todayMeals = meals.filter(m => m.date === todayStr);
      const todayCalories = todayMeals.reduce((sum, m) => sum + Number(m.calories || 0), 0);
      const lastSevenDates = Array.from({ length: 7 }, (_, i) => formatDate(new Date(Date.now() - i * 86400000)));
      const lastSevenSet = new Set(lastSevenDates);
      const lastSevenTotals = {};
      let sevenDayTotal = 0;
      meals.forEach(m => {
        const calories = Number(m.calories || 0);
        if (lastSevenSet.has(m.date)) {
          sevenDayTotal += calories;
          lastSevenTotals[m.date] = (lastSevenTotals[m.date] || 0) + calories;
        }
      });
      const sevenDayAverage = sevenDayTotal / 7;
      const busiestDay = Object.keys(lastSevenTotals).sort((a, b) => lastSevenTotals[b] - lastSevenTotals[a])[0];
      const lastMeal = meals.slice().sort((a, b) => {
        if (a.date === b.date) {
          return (a.time || '').localeCompare(b.time || '');
        }
        return a.date.localeCompare(b.date);
      }).pop();
      return {
        todayStr,
        todayMeals,
        todayCalories,
        lastSevenTotals,
        sevenDayTotal,
        sevenDayAverage,
        busiestDay,
        totalMeals: meals.length,
        lastMeal: lastMeal || null,
      };
    }

    function renderSummary() {
      const stats = getMealAnalytics();
      summaryList.innerHTML = '';

      const items = [
        {
          label: 'Today',
          value: `${Math.round(stats.todayCalories)} kcal`,
          detail: stats.todayMeals.length ? `${stats.todayMeals.length} meal${stats.todayMeals.length > 1 ? 's' : ''}` : 'Log your first meal',
        },
        {
          label: '7 day average',
          value: `${Math.round(stats.sevenDayAverage)} kcal`,
          detail: stats.sevenDayTotal ? `${stats.sevenDayTotal} kcal total` : 'Awaiting more data',
        },
        {
          label: 'Top day (last 7)',
          value: stats.busiestDay ? `${stats.lastSevenTotals[stats.busiestDay]} kcal` : '—',
          detail: stats.busiestDay ? formatHumanDate(stats.busiestDay) : 'Log more meals for insights',
        },
        {
          label: 'All time meals',
          value: stats.totalMeals,
          detail: stats.totalMeals ? 'Keep the streak going!' : 'Start your journey today',
        },
      ];

      items.forEach(item => {
        const li = document.createElement('li');
        li.innerHTML = `<strong>${item.label}</strong><span>${item.value}${item.detail ? ` · ${item.detail}` : ''}</span>`;
        summaryList.appendChild(li);
      });
    }

    function updateStatCard(card, value, detail, tone = 'neutral') {
      if (!card) return;
      const valueEl = card.querySelector('[data-field="value"]');
      const detailEl = card.querySelector('[data-field="detail"]');
      if (valueEl) valueEl.textContent = value;
      if (detailEl) detailEl.textContent = detail;
      card.classList.remove('positive', 'warning', 'danger');
      if (tone !== 'neutral') {
        card.classList.add(tone);
      }
    }

    function getLatestWeight() {
      if (weightHistory.length > 0) {
        return Number(weightHistory[weightHistory.length - 1].weight);
      }
      return profile.weight ? Number(profile.weight) : null;
    }

    function renderAnalytics() {
      const stats = getMealAnalytics();
      updateStatCard(
        analyticsCards.today,
        `${Math.round(stats.todayCalories)} kcal`,
        stats.todayMeals.length ? `${stats.todayMeals.length} meal${stats.todayMeals.length > 1 ? 's' : ''} logged` : 'Add a meal to get started',
        stats.todayMeals.length ? 'positive' : 'neutral'
      );

      updateStatCard(
        analyticsCards.weekly,
        `${Math.round(stats.sevenDayAverage)} kcal`,
        stats.sevenDayTotal ? `${stats.sevenDayTotal} kcal across 7 days` : 'Log meals this week to unlock insights',
        stats.sevenDayTotal ? 'positive' : 'neutral'
      );

      const latestWeight = getLatestWeight();
      const targetWeight = targets.targetWeight !== '' ? Number(targets.targetWeight) : null;
      const weeklyChange = Number(targets.weeklyChange || 0);
      if (!targetWeight || !latestWeight) {
        updateStatCard(
          analyticsCards.target,
          '—',
          'Set your profile weight & target to see projections.',
          'neutral'
        );
      } else {
        const diff = targetWeight - latestWeight;
        let tone = 'positive';
        if (Math.abs(diff) < 0.1) {
          tone = 'positive';
        } else if (Math.abs(weeklyChange) < 0.1 || Math.sign(diff) !== Math.sign(weeklyChange)) {
          tone = 'warning';
        }
        let detail;
        let value;
        if (Math.abs(diff) < 0.1) {
          detail = 'Goal reached – maintain the momentum!';
          value = 'Goal met';
        } else if (Math.abs(weeklyChange) < 0.1) {
          detail = 'Specify a weekly change to forecast your arrival date.';
          value = `${Math.abs(diff).toFixed(1)} kg ${diff >= 0 ? 'to gain' : 'to lose'}`;
        } else if (Math.sign(diff) !== Math.sign(weeklyChange)) {
          detail = 'Adjust weekly change to match your goal direction.';
          value = `${Math.abs(diff).toFixed(1)} kg ${diff >= 0 ? 'to gain' : 'to lose'}`;
        } else {
          const weeksToGoal = Math.abs(diff / weeklyChange);
          detail = `≈${weeksToGoal.toFixed(1)} week${weeksToGoal >= 1.5 ? 's' : ''} at ${Math.abs(weeklyChange).toFixed(1)} kg/week`;
          value = `${Math.abs(diff).toFixed(1)} kg ${diff >= 0 ? 'to gain' : 'to lose'}`;
        }
        if (!value) {
          value = `${Math.abs(diff).toFixed(1)} kg ${diff >= 0 ? 'to gain' : 'to lose'}`;
        }
        updateStatCard(
          analyticsCards.target,
          value,
          detail,
          tone
        );
      }
    }

    function renderPresetOptions() {
      presetMealSelect.innerHTML = '';
      const placeholder = document.createElement('option');
      placeholder.value = '';
      placeholder.textContent = 'Use a preset meal…';
      presetMealSelect.appendChild(placeholder);
      presetMeals
        .slice()
        .sort((a, b) => a.name.localeCompare(b.name))
        .forEach(meal => {
          const option = document.createElement('option');
          option.value = meal.id;
          option.textContent = `${meal.name} (${meal.calories} kcal)`;
          presetMealSelect.appendChild(option);
        });
    }

    function setPresetFormMode(id = null) {
      editingPresetId = id;
      if (editingPresetId) {
        presetMealSubmitBtn.textContent = 'Update meal';
        presetMealSubmitBtn.disabled = false;
      } else {
        presetMealSubmitBtn.textContent = 'Save meal';
        presetMealSubmitBtn.disabled = presetMeals.length >= 10;
        if (presetMealSubmitBtn.disabled) {
          presetMealSubmitBtn.textContent = 'Max meals reached';
        }
      }
    }

    function renderPresetMealsList() {
      presetMealsList.innerHTML = '';
      if (presetMeals.length === 0) {
        const empty = document.createElement('div');
        empty.className = 'empty-state';
        empty.innerHTML = '<strong>No preset meals yet.</strong> Add your regulars to speed up logging.';
        presetMealsList.appendChild(empty);
        setPresetFormMode(editingPresetId);
        return;
      }
      const sorted = presetMeals.slice().sort((a, b) => a.name.localeCompare(b.name));
      sorted.forEach(meal => {
        const item = document.createElement('div');
        item.className = 'preset-item';
        const info = document.createElement('div');
        const nameEl = document.createElement('strong');
        nameEl.textContent = meal.name;
        const detail = document.createElement('span');
        const detailParts = [`${meal.calories} kcal`];
        if (meal.time) detailParts.push(meal.time);
        if (meal.ingredients) detailParts.push(meal.ingredients);
        detail.textContent = detailParts.join(' · ');
        info.appendChild(nameEl);
        info.appendChild(detail);
        const actions = document.createElement('div');
        actions.className = 'preset-actions';
        const editBtn = document.createElement('button');
        editBtn.type = 'button';
        editBtn.className = 'edit';
        editBtn.dataset.id = meal.id;
        editBtn.textContent = 'Edit';
        const deleteBtn = document.createElement('button');
        deleteBtn.type = 'button';
        deleteBtn.className = 'delete';
        deleteBtn.dataset.id = meal.id;
        deleteBtn.textContent = 'Delete';
        actions.appendChild(editBtn);
        actions.appendChild(deleteBtn);
        item.appendChild(info);
        item.appendChild(actions);
        presetMealsList.appendChild(item);
      });
      setPresetFormMode(editingPresetId);
    }

    function openPresetMealsModal() {
      presetMealForm.reset();
      setPresetFormMode(null);
      renderPresetMealsList();
      presetMealsModal.style.display = 'flex';
    }

    function closePresetMealsModal() {
      presetMealsModal.style.display = 'none';
      presetMealForm.reset();
      setPresetFormMode(null);
    }

    function getWeekStart(dateStr) {
      const date = new Date(`${dateStr}T00:00:00`);
      if (Number.isNaN(date.getTime())) return dateStr;
      const day = date.getDay();
      const diff = date.getDate() - day + (day === 0 ? -6 : 1);
      date.setDate(diff);
      return formatDate(date);
    }

    function computeAverageDailyChange(history) {
      if (!history || history.length < 2) return null;
      let totalChange = 0;
      let totalDays = 0;
      for (let i = 1; i < history.length; i++) {
        const prev = history[i - 1];
        const curr = history[i];
        const prevDate = new Date(`${prev.date}T00:00:00`);
        const currDate = new Date(`${curr.date}T00:00:00`);
        const days = (currDate - prevDate) / 86400000;
        if (days > 0) {
          totalChange += Number(curr.weight) - Number(prev.weight);
          totalDays += days;
        }
      }
      if (totalDays <= 0) return null;
      return totalChange / totalDays;
    }

    function getWeightPoints(range) {
      const sorted = weightHistory.slice().sort((a, b) => a.date.localeCompare(b.date));
      const toPoint = entry => ({
        date: entry.date,
        label: formatHumanDate(entry.date),
        weight: Number(entry.weight),
      });
      if (sorted.length > 0) {
        if (range === 'daily') {
          return { points: sorted.map(toPoint), projected: false };
        }
        if (range === 'weekly') {
          const groups = {};
          sorted.forEach(entry => {
            const key = getWeekStart(entry.date);
            if (!groups[key]) groups[key] = { weight: 0, count: 0 };
            groups[key].weight += Number(entry.weight);
            groups[key].count += 1;
          });
          const points = Object.keys(groups)
            .sort((a, b) => a.localeCompare(b))
            .map(key => ({
              date: key,
              label: formatHumanDate(key),
              weight: groups[key].weight / groups[key].count,
            }));
          return { points, projected: false };
        }
        if (range === 'monthly') {
          const groups = {};
          sorted.forEach(entry => {
            const key = entry.date.slice(0, 7);
            if (!groups[key]) groups[key] = { weight: 0, count: 0 };
            groups[key].weight += Number(entry.weight);
            groups[key].count += 1;
          });
          const points = Object.keys(groups)
            .sort((a, b) => a.localeCompare(b))
            .map(key => {
              const [year, month] = key.split('-');
              const displayDate = new Date(`${key}-01T00:00:00`);
              return {
                date: `${key}-01`,
                label: displayDate.toLocaleDateString(undefined, { month: 'short', year: 'numeric' }),
                weight: groups[key].weight / groups[key].count,
              };
            });
          return { points, projected: false };
        }
      }
      const baselineWeight = profile.weight ? Number(profile.weight) : null;
      const targetWeight = targets.targetWeight !== '' ? Number(targets.targetWeight) : null;
      const weeklyChange = Number(targets.weeklyChange || 0);
      if (!baselineWeight || !targetWeight || Math.abs(weeklyChange) < 0.1 || Math.sign(targetWeight - baselineWeight) !== Math.sign(weeklyChange)) {
        return { points: [], projected: false };
      }
      const totalWeeks = Math.min(24, Math.ceil(Math.abs((targetWeight - baselineWeight) / weeklyChange)));
      const points = [];
      for (let i = 0; i <= totalWeeks; i++) {
        const date = new Date();
        date.setDate(date.getDate() + i * 7);
        const weightValue = baselineWeight + weeklyChange * i;
        points.push({
          date: formatDate(date),
          label: formatHumanDate(formatDate(date)),
          weight: weightValue,
        });
      }
      return { points, projected: true };
    }

    function renderWeightChart(range = currentWeightRange) {
      currentWeightRange = range;
      Array.from(weightRangeSelect.querySelectorAll('button')).forEach(btn => {
        btn.classList.toggle('active', btn.dataset.range === range);
      });
      const ctx = weightChart.getContext('2d');
      const width = weightChart.clientWidth || weightChart.width;
      const height = weightChart.clientHeight || weightChart.height;
      if (weightChart.width !== width) weightChart.width = width;
      if (weightChart.height !== height) weightChart.height = height;
      ctx.clearRect(0, 0, weightChart.width, weightChart.height);
      const { points, projected } = getWeightPoints(range);
      if (points.length === 0) {
        weightEmptyState.hidden = false;
        updateWeightTrajectoryText(projected, []);
        return;
      }
      weightEmptyState.hidden = true;
      ctx.fillStyle = '#fff';
      ctx.fillRect(0, 0, width, height);

      const padding = { left: 56, right: 24, top: 32, bottom: 40 };
      const chartWidth = width - padding.left - padding.right;
      const chartHeight = height - padding.top - padding.bottom;
      const weights = points.map(p => p.weight);
      const targetWeight = targets.targetWeight !== '' ? Number(targets.targetWeight) : null;
      if (targetWeight) weights.push(targetWeight);
      let minWeight = Math.min(...weights);
      let maxWeight = Math.max(...weights);
      if (minWeight === maxWeight) {
        minWeight -= 1;
        maxWeight += 1;
      }
      const rangeWeight = maxWeight - minWeight;

      const coords = points.map((point, index) => {
        const ratio = points.length === 1 ? 0.5 : index / (points.length - 1);
        const x = padding.left + chartWidth * ratio;
        const y = padding.top + chartHeight * (1 - (point.weight - minWeight) / rangeWeight);
        return { ...point, x, y };
      });

      ctx.lineWidth = 3;
      ctx.strokeStyle = projected ? 'rgba(92,106,196,0.6)' : 'rgba(45,156,219,0.85)';
      ctx.setLineDash(projected ? [6, 6] : []);
      ctx.beginPath();
      coords.forEach((c, i) => {
        if (i === 0) ctx.moveTo(c.x, c.y);
        else ctx.lineTo(c.x, c.y);
      });
      ctx.stroke();
      ctx.setLineDash([]);

      if (coords.length > 1) {
        ctx.fillStyle = 'rgba(45,156,219,0.16)';
        ctx.beginPath();
        coords.forEach((c, i) => {
          if (i === 0) ctx.moveTo(c.x, c.y);
          else ctx.lineTo(c.x, c.y);
        });
        ctx.lineTo(coords[coords.length - 1].x, padding.top + chartHeight);
        ctx.lineTo(coords[0].x, padding.top + chartHeight);
        ctx.closePath();
        ctx.fill();
      }

      ctx.fillStyle = projected ? 'rgba(92,106,196,0.9)' : 'rgba(45,156,219,0.95)';
      coords.forEach(c => {
        ctx.beginPath();
        ctx.arc(c.x, c.y, 4.5, 0, Math.PI * 2);
        ctx.fill();
      });

      ctx.fillStyle = '#5c6c86';
      ctx.font = '12px "Inter", sans-serif';
      const labelIndices = new Set([0, coords.length - 1]);
      if (coords.length > 2) labelIndices.add(Math.floor(coords.length / 2));
      labelIndices.forEach(index => {
        const c = coords[index];
        ctx.fillText(c.label, c.x - 30, padding.top + chartHeight + 20);
      });
      ctx.fillText(`${minWeight.toFixed(1)} kg`, 6, padding.top + chartHeight);
      ctx.fillText(`${maxWeight.toFixed(1)} kg`, 6, padding.top + 12);

      if (targetWeight) {
        const targetY = padding.top + chartHeight * (1 - (targetWeight - minWeight) / rangeWeight);
        ctx.strokeStyle = 'rgba(247,108,108,0.8)';
        ctx.setLineDash([4, 4]);
        ctx.beginPath();
        ctx.moveTo(padding.left, targetY);
        ctx.lineTo(padding.left + chartWidth, targetY);
        ctx.stroke();
        ctx.setLineDash([]);
        ctx.fillStyle = 'rgba(247,108,108,0.85)';
        ctx.fillText(`Target ${targetWeight.toFixed(1)} kg`, padding.left + 6, targetY - 6);
      }

      updateWeightTrajectoryText(projected, coords);
    }

    function renderWeightCard() {
      if (weightHistory.length === 0) {
        if (profile.weight) {
          weightCardFields.weight.textContent = `${Number(profile.weight).toFixed(1)} kg`;
          weightCardFields.delta.textContent = 'Baseline from your profile';
          weightCardFields.updated.textContent = 'Tap to start logging weigh-ins';
        } else {
          weightCardFields.weight.textContent = '— kg';
          weightCardFields.delta.textContent = 'No weight updates yet';
          weightCardFields.updated.textContent = 'Tap to log and view your journey';
        }
      } else {
        const last = weightHistory[weightHistory.length - 1];
        const previous = weightHistory.length > 1 ? weightHistory[weightHistory.length - 2] : null;
        weightCardFields.weight.textContent = `${Number(last.weight).toFixed(1)} kg`;
        if (previous) {
          const change = Number(last.weight) - Number(previous.weight);
          if (Math.abs(change) < 0.05) {
            weightCardFields.delta.textContent = `Holding steady since ${formatHumanDate(previous.date)}`;
          } else {
            weightCardFields.delta.textContent = `${change > 0 ? '▲' : '▼'} ${Math.abs(change).toFixed(1)} kg since ${formatHumanDate(previous.date)}`;
          }
        } else {
          weightCardFields.delta.textContent = 'First entry logged';
        }
        weightCardFields.updated.textContent = `Updated ${formatHumanDate(last.date)}`;
      }
      renderWeightChart(currentWeightRange);
    }

    function openWeightModal() {
      const latest = getLatestWeight();
      weightDateInput.value = formatDate(new Date());
      weightValueInput.value = latest ? Number(latest).toFixed(1) : (profile.weight ? Number(profile.weight).toFixed(1) : '');
      weightModal.style.display = 'flex';
      renderWeightChart(currentWeightRange);
    }

    function closeWeightModal() {
      weightModal.style.display = 'none';
    }

    function updateWeightTrajectoryText(projected, coords) {
      const latestWeight = getLatestWeight();
      const targetWeight = targets.targetWeight !== '' ? Number(targets.targetWeight) : null;
      const plannedWeekly = Number(targets.weeklyChange || 0);
      const trend = computeAverageDailyChange(weightHistory);
      const trendWeekly = trend ? trend * 7 : null;
      if (!latestWeight) {
        if (projected && plannedWeekly) {
          weightTrajectoryText.textContent = `Following your plan of ${Math.abs(plannedWeekly).toFixed(1)} kg/week you could reach ${targetWeight?.toFixed(1) ?? 'your goal'} once you start logging.`;
        } else {
          weightTrajectoryText.textContent = 'Log your weight to start charting progress.';
        }
        return;
      }
      if (!targetWeight) {
        if (trendWeekly && Math.abs(trendWeekly) >= 0.05) {
          weightTrajectoryText.textContent = `Average change: ${trendWeekly > 0 ? '+' : ''}${trendWeekly.toFixed(2)} kg/week across your last ${weightHistory.length} log${weightHistory.length > 1 ? 's' : ''}.`;
        } else {
          weightTrajectoryText.textContent = 'Set a target weight to unlock trajectory forecasts.';
        }
        return;
      }
      const diff = targetWeight - latestWeight;
      if (Math.abs(diff) < 0.1) {
        weightTrajectoryText.textContent = 'You are sitting right at your goal weight – maintain the habits that got you here!';
        return;
      }
      let rate = trendWeekly;
      let source = 'recent trend';
      if (!rate || Math.abs(rate) < 0.05 || Math.sign(rate) !== Math.sign(diff)) {
        if (Math.abs(plannedWeekly) >= 0.1 && Math.sign(plannedWeekly) === Math.sign(diff)) {
          rate = plannedWeekly;
          source = 'target plan';
        } else {
          weightTrajectoryText.textContent = 'Adjust your weekly target or keep logging to plot a reliable trajectory.';
          return;
        }
      }
      const weeks = Math.abs(diff / rate);
      const projectedDate = new Date(Date.now() + weeks * 7 * 86400000);
      weightTrajectoryText.textContent = `At ${Math.abs(rate).toFixed(2)} kg/week (${source}) you could hit ${targetWeight.toFixed(1)} kg in ≈${weeks.toFixed(1)} weeks (${projectedDate.toLocaleDateString()}).`;
    }

    function getBMICategoryLabel(bmi) {
      if (bmi < 18.5) return 'Underweight';
      if (bmi < 25) return 'Healthy';
      if (bmi < 30) return 'Overweight';
      return 'Obese';
    }

    function updateBMIFromInputs() {
      const heightCm = Number(profileHeightInput.value);
      const weightKg = Number(profileWeightInput.value);
      if (!heightCm || !weightKg) {
        bmiValue.textContent = '—';
        bmiCategory.textContent = '';
        return;
      }
      const heightM = heightCm / 100;
      const bmi = weightKg / (heightM * heightM);
      if (!Number.isFinite(bmi) || bmi <= 0) {
        bmiValue.textContent = '—';
        bmiCategory.textContent = '';
        return;
      }
      bmiValue.textContent = bmi.toFixed(1);
      bmiCategory.textContent = `(${getBMICategoryLabel(bmi)})`;
    }

    function populateProfileForm() {
      profileAgeInput.value = profile.age ?? '';
      profileHeightInput.value = profile.height ?? '';
      profileWeightInput.value = profile.weight ?? '';
      profileLifestyleSelect.value = profile.lifestyle || 'moderate';
      updateBMIFromInputs();
    }

    function populateTargetForm() {
      targetWeightInput.value = targets.targetWeight !== '' ? targets.targetWeight : '';
      goalTypeSelect.value = targets.goalType || 'maintain';
      const weeklyAbs = Math.abs(Number(targets.weeklyChange || 0));
      weeklyChangeInput.value = weeklyAbs ? weeklyAbs.toString() : '';
      updateTargetProjection();
    }

    function getDraftTargetsFromForm() {
      const targetWeightValue = targetWeightInput.value;
      const goalType = goalTypeSelect.value || 'maintain';
      const parsedTargetWeight = targetWeightValue === '' ? '' : Number(targetWeightValue);
      const baseWeekly = weeklyChangeInput.value === '' ? 0 : Number(weeklyChangeInput.value);
      const weeklyAbs = Number.isFinite(baseWeekly) ? Math.min(Math.abs(baseWeekly), 5) : 0;
      let weeklyChange = 0;
      if (goalType === 'loss') weeklyChange = -weeklyAbs;
      else if (goalType === 'gain') weeklyChange = weeklyAbs;
      return {
        targetWeight: parsedTargetWeight === '' || Number.isNaN(parsedTargetWeight) ? '' : parsedTargetWeight,
        goalType,
        weeklyChange
      };
    }

    function updateTargetProjection() {
      const draftTargets = getDraftTargetsFromForm();
      const targetWeight = draftTargets.targetWeight !== '' ? Number(draftTargets.targetWeight) : null;
      if (!targetWeight) {
        targetProjection.textContent = 'Set your targets to unlock smart projections.';
        return;
      }
      const currentWeight = getLatestWeight();
      if (!currentWeight) {
        targetProjection.textContent = 'Log a current weight to map your path to the goal.';
        return;
      }
      const diff = targetWeight - currentWeight;
      const weeklyChange = Number(draftTargets.weeklyChange || 0);
      if (Math.abs(diff) < 0.1) {
        targetProjection.textContent = 'You are already sitting at your target weight – amazing work!';
        return;
      }
      if (Math.abs(weeklyChange) < 0.1) {
        targetProjection.textContent = 'Add a weekly change to estimate how long your journey will take.';
        return;
      }
      if (Math.sign(diff) !== Math.sign(weeklyChange)) {
        targetProjection.textContent = 'Weekly change direction does not match your goal. Flip the sign or adjust the plan.';
        return;
      }
      const weeks = Math.abs(diff / weeklyChange);
      const projectedDate = new Date(Date.now() + weeks * 7 * 86400000);
      targetProjection.textContent = `≈${weeks.toFixed(1)} weeks to goal. Projected around ${projectedDate.toLocaleDateString()}.`;
    }

    mealForm.addEventListener('submit', (e) => {
      e.preventDefault();
      const date = mealDateInput.value;
      const name = mealNameInput.value.trim();
      const time = mealTimeInput.value;
      const ingredients = mealIngredientsInput.value
        .split(',')
        .map(s => s.trim())
        .filter(s => s);
      const calories = Number(mealCaloriesInput.value);
      if (!date || !name || isNaN(calories)) {
        alert('Please fill in all required fields.');
        return;
      }
      const meal = { id: generateId(), date, time: time || '', name, ingredients, calories };
      meals.push(meal);
      saveToStorage('meals', meals);
      mealForm.reset();
      // reset date to today after submission
      mealDateInput.value = formatDate(new Date());
      presetMealSelect.value = '';
      renderMeals();
    });

    // Delegate deletion to table body
    mealTableBody.addEventListener('click', (e) => {
      if (e.target.classList.contains('meal-delete')) {
        const id = e.target.getAttribute('data-id');
        if (confirm('Delete this meal?')) {
          meals = meals.filter(m => m.id !== id);
          saveToStorage('meals', meals);
          renderMeals();
        }
      }
    });

    managePresetMealsBtn.addEventListener('click', openPresetMealsModal);
    cancelPresetMealBtn.addEventListener('click', closePresetMealsModal);
    presetMealsModal.addEventListener('click', (e) => {
      if (e.target === presetMealsModal) {
        closePresetMealsModal();
      }
    });

    presetMealForm.addEventListener('submit', (e) => {
      e.preventDefault();
      if (!editingPresetId && presetMeals.length >= 10) {
        alert('You can store up to 10 preset meals. Delete one to add another.');
        return;
      }
      const name = presetMealNameInput.value.trim();
      const calories = Number(presetMealCaloriesInput.value);
      if (!name || Number.isNaN(calories)) {
        alert('Please provide a name and calories for the preset meal.');
        return;
      }
      const presetData = {
        id: editingPresetId || generateId(),
        name,
        calories: Math.max(0, Math.round(calories)),
        time: presetMealTimeInput.value || '',
        ingredients: presetMealIngredientsInput.value.trim(),
      };
      if (editingPresetId) {
        const idx = presetMeals.findIndex(m => m.id === editingPresetId);
        if (idx >= 0) {
          presetMeals[idx] = presetData;
        }
      } else {
        presetMeals.push(presetData);
      }
      saveToStorage('presetMeals', presetMeals);
      renderPresetMealsList();
      renderPresetOptions();
      presetMealForm.reset();
      setPresetFormMode(null);
    });

    presetMealsList.addEventListener('click', (e) => {
      const button = e.target.closest('button');
      if (!button) return;
      const id = button.dataset.id;
      if (!id) return;
      if (button.classList.contains('edit')) {
        const meal = presetMeals.find(m => m.id === id);
        if (meal) {
          presetMealNameInput.value = meal.name;
          presetMealIngredientsInput.value = meal.ingredients || '';
          presetMealCaloriesInput.value = meal.calories;
          presetMealTimeInput.value = meal.time || '';
          setPresetFormMode(meal.id);
        }
      } else if (button.classList.contains('delete')) {
        if (confirm('Delete this preset meal?')) {
          presetMeals = presetMeals.filter(m => m.id !== id);
          saveToStorage('presetMeals', presetMeals);
          renderPresetMealsList();
          renderPresetOptions();
          setPresetFormMode(null);
        }
      }
    });

    presetMealSelect.addEventListener('change', () => {
      const selectedId = presetMealSelect.value;
      if (!selectedId) return;
      const preset = presetMeals.find(m => m.id === selectedId);
      if (preset) {
        mealNameInput.value = preset.name;
        mealCaloriesInput.value = preset.calories;
        mealIngredientsInput.value = preset.ingredients || '';
        mealTimeInput.value = preset.time || '';
      }
    });

    profileForm.addEventListener('submit', (e) => {
      e.preventDefault();
      profile = {
        age: profileAgeInput.value ? Number(profileAgeInput.value) : '',
        height: profileHeightInput.value ? Number(profileHeightInput.value) : '',
        weight: profileWeightInput.value ? Number(profileWeightInput.value) : '',
        lifestyle: profileLifestyleSelect.value,
      };
      saveToStorage('profile', profile);
      populateProfileForm();
      renderWeightCard();
      renderAnalytics();
      updateTargetProjection();
    });

    [profileHeightInput, profileWeightInput].forEach(input => {
      input.addEventListener('input', updateBMIFromInputs);
    });

    targetForm.addEventListener('submit', (e) => {
      e.preventDefault();
      const targetWeightValue = targetWeightInput.value ? Number(targetWeightInput.value) : '';
      if (targetWeightInput.value && Number.isNaN(targetWeightValue)) {
        alert('Enter a valid target weight.');
        return;
      }
      let weeklyChange = weeklyChangeInput.value ? Number(weeklyChangeInput.value) : 0;
      if (Number.isNaN(weeklyChange)) weeklyChange = 0;
      weeklyChange = Math.min(Math.abs(weeklyChange), 5);
      const goalType = goalTypeSelect.value;
      if (goalType === 'loss') weeklyChange = -weeklyChange;
      else if (goalType === 'gain') weeklyChange = Math.abs(weeklyChange);
      else weeklyChange = 0;
      targets = {
        targetWeight: targetWeightValue === '' ? '' : Number(targetWeightValue),
        goalType,
        weeklyChange,
      };
      saveToStorage('targets', targets);
      populateTargetForm();
      renderAnalytics();
      renderWeightCard();
    });

    goalTypeSelect.addEventListener('change', updateTargetProjection);
    targetWeightInput.addEventListener('input', updateTargetProjection);
    weeklyChangeInput.addEventListener('input', () => {
      const rawStr = weeklyChangeInput.value;
      if (rawStr === '') {
        updateTargetProjection();
        return;
      }
      const raw = Number(rawStr);
      if (Number.isNaN(raw)) {
        weeklyChangeInput.value = '';
      } else {
        const clamped = Math.min(Math.abs(raw), 5);
        weeklyChangeInput.value = clamped.toString();
      }
      updateTargetProjection();
    });

    weightCard.addEventListener('click', openWeightModal);
    quickWeightLogBtn.addEventListener('click', openWeightModal);
    closeWeightModalBtn.addEventListener('click', closeWeightModal);
    weightModal.addEventListener('click', (e) => {
      if (e.target === weightModal) closeWeightModal();
    });

    Array.from(weightRangeSelect.querySelectorAll('button')).forEach(btn => {
      btn.addEventListener('click', () => {
        renderWeightChart(btn.dataset.range);
      });
    });

    weightForm.addEventListener('submit', (e) => {
      e.preventDefault();
      const date = weightDateInput.value;
      const weightVal = Number(weightValueInput.value);
      if (!date || Number.isNaN(weightVal)) {
        alert('Please enter a valid date and weight.');
        return;
      }
      const existingIndex = weightHistory.findIndex(entry => entry.date === date);
      if (existingIndex >= 0) {
        weightHistory[existingIndex].weight = weightVal;
      } else {
        weightHistory.push({ date, weight: weightVal });
      }
      weightHistory.sort((a, b) => a.date.localeCompare(b.date));
      saveToStorage('weightHistory', weightHistory);
      profile.weight = Number(weightVal.toFixed(1));
      profileWeightInput.value = profile.weight;
      saveToStorage('profile', profile);
      updateBMIFromInputs();
      renderWeightCard();
      renderAnalytics();
      updateTargetProjection();
      weightDateInput.value = formatDate(new Date());
    });

    renderPresetOptions();
    renderPresetMealsList();

    // Initialize meal date input to today
    mealDateInput.value = formatDate(new Date());
    renderMeals();
    populateProfileForm();
    populateTargetForm();
    renderWeightCard();

    // ===== KANBAN BOARD =====
    let tasks = (loadFromStorage('tasks', []) || []).map(normalizeTask).filter(Boolean);
    if (tasks.length === 0) {
      // Demo tasks
      tasks = [
        { id: generateId(), title: 'Setup project repo', description: 'Initialize repository and README.', priority: 'high', assigned: ['Alice'], status: 'todo' },
        { id: generateId(), title: 'Design UI mockups', description: 'Create wireframes for the new app.', priority: 'medium', assigned: ['Bob', 'Clara'], status: 'doing' },
        { id: generateId(), title: 'Review PR #42', description: 'Code review and merge changes.', priority: 'low', assigned: ['Dan'], status: 'done' },
      ];
      saveToStorage('tasks', tasks);
    }
    // WIP limits: default values loaded from storage or defaults
    let wipLimits = normalizeWipLimits(loadFromStorage('wipLimits', { todo: null, doing: 3, done: null }));
    document.getElementById('limit-todo').value = wipLimits.todo ?? '';
    document.getElementById('limit-doing').value = wipLimits.doing ?? '';
    document.getElementById('limit-done').value = wipLimits.done ?? '';

    const taskSearchInput = document.getElementById('taskSearch');
    const addTaskBtn = document.getElementById('addTaskBtn');
    const taskModal = document.getElementById('taskModal');
    const taskForm = document.getElementById('taskForm');
    const taskModalTitle = document.getElementById('taskModalTitle');
    const cancelTaskBtn = document.getElementById('cancelTaskBtn');

    let editingTaskId = null;

    const boardWarning = document.createElement('div');
    boardWarning.className = 'callout';
    boardWarning.style.display = 'none';
    const kanbanSection = document.getElementById('kanbanSection');
    if (kanbanSection) {
      const board = kanbanSection.querySelector('.kanban-board');
      if (board && board.parentNode) {
        board.parentNode.insertBefore(boardWarning, board);
      }
    }

    function showBoardWarning(message) {
      if (!boardWarning) return;
      boardWarning.textContent = message;
      boardWarning.style.display = 'block';
      clearTimeout(showBoardWarning._timer);
      showBoardWarning._timer = setTimeout(() => {
        boardWarning.style.display = 'none';
      }, 2200);
    }

    function renderBoard() {
      // Clear existing tasks
      ['todo','doing','done'].forEach(status => {
        const container = document.getElementById(`tasks-${status}`);
        container.innerHTML = '';
      });
      // Filter tasks by search
      const searchTerm = taskSearchInput.value.toLowerCase();
      tasks.forEach(task => {
        if (searchTerm && !task.title.toLowerCase().includes(searchTerm) && !task.assigned.some(a => a.toLowerCase().includes(searchTerm))) {
          return;
        }
        const card = document.createElement('div');
        card.className = 'kanban-card';
        card.setAttribute('draggable', 'true');
        card.dataset.id = task.id;
        card.dataset.priority = task.priority;
        card.innerHTML = `
          <h4>${escapeHtml(task.title)}</h4>
          <p>${escapeHtml(task.description)}</p>
          <div class="card-footer">
            <div class="assigned">
              ${task.assigned.map(name => {
                const initial = escapeHtml(name.trim().charAt(0).toUpperCase());
                const color = hashStringToColor(name.trim());
                return `<div class="avatar" style="background-color:${color}" title="${escapeHtml(name.trim())}">${initial}</div>`;
              }).join('')}
            </div>
            <span class="delete-btn" data-id="${task.id}">✕</span>
          </div>
        `;
        // Drag events
        card.addEventListener('dragstart', (ev) => {
          ev.dataTransfer.setData('text/plain', task.id);
        });
        // Delete event
        card.querySelector('.delete-btn').addEventListener('click', (ev) => {
          ev.stopPropagation();
          const id = ev.target.getAttribute('data-id');
          if (confirm('Delete this task?')) {
            tasks = tasks.filter(t => t.id !== id);
            saveToStorage('tasks', tasks);
            renderBoard();
          }
        });
        document.getElementById(`tasks-${task.status}`).appendChild(card);
      });
    }

    // Column and container drop handlers
    // Allow dropping on the column itself or the inner tasks container.  Without
    // attaching handlers to the inner container, drops may not be recognised
    // because events don’t bubble through overflow elements.
    function attachDropHandlers(element, status) {
      element.addEventListener('dragover', (ev) => {
        ev.preventDefault();
      });
      element.addEventListener('drop', (ev) => {
        ev.preventDefault();
        const id = ev.dataTransfer.getData('text/plain');
        if (!id) {
          showBoardWarning('Drop ignored: invalid task payload.');
          return;
        }
        const task = tasks.find(t => t.id === id);
        if (!task) {
          showBoardWarning('Drop ignored: task no longer exists.');
          return;
        }
        const targetStatus = status;
        const limit = wipLimits[targetStatus];
        if (limit !== null && limit !== undefined && limit !== '' && limit >= 0) {
          const currentCount = tasks.filter(t => t.status === targetStatus).length;
          if (currentCount >= limit && task.status !== targetStatus) {
            showBoardWarning(`Cannot move: WIP limit for ${targetStatus.toUpperCase()} is ${limit}.`);
            return;
          }
        }
        if (task) {
          task.status = targetStatus;
          saveToStorage('tasks', tasks);
          renderBoard();
        }
      });
    }
    document.querySelectorAll('.kanban-column').forEach(column => {
      const status = column.dataset.status;
      attachDropHandlers(column, status);
      const tasksContainer = column.querySelector('.kanban-tasks');
      if (tasksContainer) attachDropHandlers(tasksContainer, status);
    });

    // Search filtering
    taskSearchInput.addEventListener('input', renderBoard);

    // Update WIP limits
    ['limit-todo','limit-doing','limit-done'].forEach(inputId => {
      const input = document.getElementById(inputId);
      input.addEventListener('change', () => {
        const status = inputId.split('-')[1];
        const value = input.value;
        const parsed = value === '' ? null : Number(value);
        wipLimits[status] = Number.isFinite(parsed) && parsed >= 0 ? parsed : null;
        saveToStorage('wipLimits', wipLimits);
        renderBoard();
      });
    });

    // Show task modal
    addTaskBtn.addEventListener('click', () => {
      editingTaskId = null;
      taskModalTitle.textContent = 'Add Task';
      taskForm.reset();
      taskModal.style.display = 'flex';
    });
    cancelTaskBtn.addEventListener('click', () => {
      taskModal.style.display = 'none';
    });
    taskModal.addEventListener('click', (ev) => {
      if (ev.target === taskModal) taskModal.style.display = 'none';
    });
    taskForm.addEventListener('submit', (e) => {
      e.preventDefault();
      const title = document.getElementById('taskTitle').value.trim();
      const description = document.getElementById('taskDesc').value.trim();
      const priority = document.getElementById('taskPriority').value;
      const assigned = document.getElementById('taskAssigned').value
        .split(',')
        .map(s => s.trim())
        .filter(s => s);
      if (!title) {
        alert('Title is required.');
        return;
      }
      if (editingTaskId) {
        const task = tasks.find(t => t.id === editingTaskId);
        if (task) {
          task.title = title;
          task.description = description;
          task.priority = priority;
          task.assigned = assigned;
        }
      } else {
        tasks.push({ id: generateId(), title, description, priority, assigned, status: 'todo' });
      }
      saveToStorage('tasks', tasks);
      taskModal.style.display = 'none';
      renderBoard();
    });

    renderBoard();

    // ===== HABIT TRACKER =====
    let habits = (loadFromStorage('habits', []) || []).map(normalizeHabit).filter(Boolean);
    if (habits.length === 0) {
      // Demo habits with example history for last few days
      const today = new Date();
      const dates = [];
      for (let i = 6; i >= 0; i--) {
        const d = new Date(Date.now() - i * 86400000);
        dates.push(formatDate(d));
      }
      habits = [
        { id: generateId(), name: 'Morning Run', color: '#FF6F61', history: {} },
        { id: generateId(), name: 'Drink Water', color: '#2AB7CA', history: {} },
        { id: generateId(), name: 'Read Book', color: '#E5C454', history: {} },
      ];
      habits.forEach((habit, index) => {
        dates.forEach((dateStr, idx) => {
          // Fill in sample: alternate patterns
          const mod = (index + idx) % 3;
          if (mod === 0) habit.history[dateStr] = 'done';
          else if (mod === 1) habit.history[dateStr] = 'skip';
          else habit.history[dateStr] = 'none';
        });
      });
      saveToStorage('habits', habits);
    }

    const habitTable = document.getElementById('habitTable');
    const addHabitBtn = document.getElementById('addHabitBtn');
    const exportHabitsBtn = document.getElementById('exportHabitsBtn');
    const importHabitsInput = document.getElementById('importHabitsInput');
    const habitModal = document.getElementById('habitModal');
    const habitForm = document.getElementById('habitForm');
    const habitModalTitle = document.getElementById('habitModalTitle');
    const cancelHabitBtn = document.getElementById('cancelHabitBtn');

    let editingHabitId = null;

    function getLastNDates(n) {
      const dates = [];
      for (let i = n - 1; i >= 0; i--) {
        const d = new Date(Date.now() - i * 86400000);
        dates.push(formatDate(d));
      }
      return dates;
    }

    function calculateStreak(history) {
      let streak = 0;
      let date = new Date();
      while (true) {
        const key = formatDate(date);
        const state = history[key];
        if (state === 'done' || state === 'skip') {
          if (state === 'done') streak++;
          date = new Date(date.getTime() - 86400000);
          continue;
        }
        break;
      }
      return streak;
    }

    function renderHabits() {
      habitTable.innerHTML = '';
      const dates = getLastNDates(14);
      // Table header row for dates (if needed) can be implemented separately
      habits.forEach(habit => {
        const row = document.createElement('div');
        row.className = 'habit-row';
        // Name and actions
        const nameCol = document.createElement('div');
        nameCol.className = 'habit-name';
        const colorIndicator = document.createElement('span');
        colorIndicator.className = 'color-indicator';
        colorIndicator.style.backgroundColor = habit.color;
        const nameSpan = document.createElement('span');
        nameSpan.textContent = habit.name;
        const streakSpan = document.createElement('span');
        streakSpan.className = 'habit-streak';
        streakSpan.textContent = `Streak: ${calculateStreak(habit.history)}`;
        nameCol.appendChild(colorIndicator);
        nameCol.appendChild(nameSpan);
        nameCol.appendChild(streakSpan);
        row.appendChild(nameCol);
        // Chart
        const chartCol = document.createElement('div');
        const canvas = document.createElement('canvas');
        canvas.className = 'habit-chart';
        canvas.width = 100;
        canvas.height = 40;
        chartCol.appendChild(canvas);
        row.appendChild(chartCol);
        // Cells
        const cellsCol = document.createElement('div');
        cellsCol.className = 'habit-cells';
        dates.forEach(dateStr => {
          const cell = document.createElement('div');
          const state = habit.history[dateStr] || 'none';
          cell.className = `habit-cell ${state}`;
          cell.dataset.date = dateStr;
          cell.dataset.habitId = habit.id;
          cell.textContent = state === 'skip' ? 'S' : (state === 'done' ? '✔' : '');
          cell.addEventListener('click', () => {
            cycleHabitState(habit.id, dateStr);
          });
          cellsCol.appendChild(cell);
        });
        row.appendChild(cellsCol);
        // Actions
        const actionsCol = document.createElement('div');
        actionsCol.className = 'habit-actions';
        const editBtn = document.createElement('span');
        editBtn.className = 'edit-btn';
        editBtn.textContent = 'Edit';
        editBtn.addEventListener('click', () => {
          editingHabitId = habit.id;
          habitModalTitle.textContent = 'Edit Habit';
          document.getElementById('habitName').value = habit.name;
          habitModal.style.display = 'flex';
        });
        const deleteBtn = document.createElement('span');
        deleteBtn.className = 'delete-btn';
        deleteBtn.textContent = 'Delete';
        deleteBtn.addEventListener('click', () => {
          if (confirm('Delete this habit?')) {
            habits = habits.filter(h => h.id !== habit.id);
            saveToStorage('habits', habits);
            renderHabits();
          }
        });
        actionsCol.appendChild(editBtn);
        actionsCol.appendChild(deleteBtn);
        row.appendChild(actionsCol);
        habitTable.appendChild(row);
      });
      drawAllCharts();
    }

    function cycleHabitState(habitId, dateStr) {
      const habit = habits.find(h => h.id === habitId);
      if (!habit) return;
      const current = habit.history[dateStr] || 'none';
      let next;
      if (current === 'none') next = 'done';
      else if (current === 'done') next = 'skip';
      else next = 'none';
      habit.history[dateStr] = next;
      saveToStorage('habits', habits);
      renderHabits();
    }

    function drawAllCharts() {
      const dates = getLastNDates(14);
      habits.forEach(habit => {
        const row = habitTable.querySelector(`[data-habit-id]`);
      });
      // For each canvas
      const canvases = document.querySelectorAll('.habit-chart');
      canvases.forEach((canvas, index) => {
        const ctx = canvas.getContext('2d');
        ctx.clearRect(0, 0, canvas.width, canvas.height);
        const habit = habits[index];
        if (!habit) return;
        const data = dates.map(d => {
          const state = habit.history[d] || 'none';
          return state === 'done' ? 1 : (state === 'skip' ? 0.5 : 0);
        });
        const barWidth = canvas.width / data.length;
        data.forEach((val, i) => {
          const x = i * barWidth;
          const h = val * canvas.height;
          ctx.fillStyle = habit.color;
          ctx.globalAlpha = val === 0.5 ? 0.5 : 1;
          ctx.fillRect(x + 1, canvas.height - h, barWidth - 2, h);
        });
        // Draw baseline line
        ctx.globalAlpha = 0.15;
        ctx.fillStyle = '#000';
        ctx.fillRect(0, canvas.height - 1, canvas.width, 1);
        ctx.globalAlpha = 1;
      });
    }

    addHabitBtn.addEventListener('click', () => {
      if (habits.length >= parseInt(getComputedStyle(document.documentElement).getPropertyValue('--max-habits'))) {
        alert('Maximum number of habits reached.');
        return;
      }
      editingHabitId = null;
      habitModalTitle.textContent = 'Add Habit';
      habitForm.reset();
      habitModal.style.display = 'flex';
    });

    cancelHabitBtn.addEventListener('click', () => {
      habitModal.style.display = 'none';
    });
    habitModal.addEventListener('click', (ev) => {
      if (ev.target === habitModal) habitModal.style.display = 'none';
    });

    habitForm.addEventListener('submit', (e) => {
      e.preventDefault();
      const name = document.getElementById('habitName').value.trim();
      if (!name) {
        alert('Habit name is required.');
        return;
      }
      if (editingHabitId) {
        const h = habits.find(hab => hab.id === editingHabitId);
        if (h) h.name = name;
      } else {
        // Assign a colour from a preset palette or random pastel
        const palette = ['#FF6F61','#6B5B95','#88B04B','#F7CAC9','#92A8D1','#955251','#B565A7'];
        const color = palette[habits.length % palette.length];
        habits.push({ id: generateId(), name, color, history: {} });
      }
      saveToStorage('habits', habits);
      habitModal.style.display = 'none';
      renderHabits();
    });

    exportHabitsBtn.addEventListener('click', () => {
      const dataStr = JSON.stringify(habits, null, 2);
      const blob = new Blob([dataStr], { type: 'application/json' });
      const url = URL.createObjectURL(blob);
      const a = document.createElement('a');
      a.href = url;
      a.download = 'habits.json';
      a.click();
      URL.revokeObjectURL(url);
    });

    importHabitsInput.addEventListener('change', (e) => {
      const file = e.target.files[0];
      if (!file) return;
      const reader = new FileReader();
      reader.onload = (evt) => {
        try {
          const imported = safeParseJSON(evt.target.result, null);
          if (!Array.isArray(imported)) {
            alert('Invalid file format. Expected an array of habits.');
            return;
          }
          const normalized = imported.map(normalizeHabit).filter(Boolean);
          if (!normalized.length && imported.length) {
            alert('Import rejected: no valid habits found in file.');
            return;
          }
          habits = normalized;
          saveToStorage('habits', habits);
          renderHabits();
        } catch (err) {
          alert('Failed to import habits: ' + err.message);
        }
      };
      reader.readAsText(file);
      // Reset input so the same file can be uploaded again later
      importHabitsInput.value = '';
    });

    window.lifeOsSelfTest = function lifeOsSelfTest() {
      const report = [];
      report.push({ check: 'meals normalized', pass: meals.every(m => m && m.id && m.name) });
      report.push({ check: 'tasks normalized', pass: tasks.every(t => t && t.id && t.title && t.status) });
      report.push({ check: 'habits normalized', pass: habits.every(h => h && h.id && h.name && h.history) });
      console.table(report);
      return report;
    };

    renderHabits();
  </script>
</body>
</html>
